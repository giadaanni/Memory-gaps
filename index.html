<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Memory Gaps</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;600&family=Orbitron:wght@700;900&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{--w:min(100vw,430px);--h:100dvh;--cr:8px;--flip:0.42s;
  --fd:'Bebas Neue',sans-serif;--fu:'DM Sans',sans-serif;--fh:'Orbitron',monospace}
html,body{width:100%;height:100%;overflow:hidden;background:#000;
  display:flex;justify-content:center;align-items:center;
  font-family:var(--fu);-webkit-tap-highlight-color:transparent;
  touch-action:manipulation;user-select:none}
#app{width:var(--w);height:var(--h);position:relative;overflow:hidden;background:#0a0a0a}

/* SCREENS */
.screen{position:absolute;inset:0;display:flex;flex-direction:column;
  align-items:center;justify-content:center;
  opacity:0;pointer-events:none;transition:opacity .4s ease;overflow:hidden}
.screen.active{opacity:1;pointer-events:all}

/* SPLASH */
#screen-splash{background:#000;cursor:pointer}
.sbg{position:absolute;inset:0;background:radial-gradient(ellipse at 50% 38%,#1a0a2e,#000 68%)}
.sparks{position:absolute;inset:0;overflow:hidden}
.spark{position:absolute;border-radius:50%;animation:sfloat linear infinite;opacity:0}
@keyframes sfloat{0%{transform:translateY(110vh) scale(0);opacity:0}10%{opacity:.9}90%{opacity:.3}100%{transform:translateY(-30px) scale(1.8);opacity:0}}
.stitle{font-family:var(--fd);font-size:clamp(60px,16vw,80px);letter-spacing:6px;color:#fff;
  line-height:.88;text-align:center;position:relative;z-index:2;margin-bottom:60px;
  text-shadow:0 0 40px rgba(160,100,255,.5),0 0 90px rgba(100,60,200,.3)}
.stitle span{display:block;font-size:.38em;letter-spacing:7px;
  color:rgba(255,255,255,.35);font-family:var(--fu);font-weight:300;margin-top:10px}
.tap{position:relative;z-index:2;font-family:var(--fh);font-size:12px;letter-spacing:5px;
  color:rgba(255,255,255,.6);text-transform:uppercase;animation:blink 1.5s ease-in-out infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.08}}

/* TILED BG */
.tbg{position:absolute;inset:0;display:grid;gap:4px;padding:4px;
  filter:blur(1.5px);opacity:.28;pointer-events:none}
.tbc{background:linear-gradient(135deg,#1a1040,#0d1a3a);border:1px solid rgba(255,255,255,.05);
  border-radius:5px;display:flex;align-items:center;justify-content:center;font-size:15px}
.tov{position:absolute;inset:0;
  background:linear-gradient(180deg,rgba(6,6,16,.78) 0%,rgba(6,6,16,.5) 50%,rgba(6,6,16,.88) 100%);
  pointer-events:none}

/* MENUS */
.menu-wrap{position:relative;z-index:2;display:flex;flex-direction:column;
  align-items:center;gap:14px;padding:36px 26px;width:100%}
.mtitle{font-family:var(--fd);font-size:clamp(34px,9vw,48px);letter-spacing:4px;color:#fff;
  text-align:center;line-height:.95}
.msub{font-size:10px;letter-spacing:3px;color:rgba(255,255,255,.38);text-transform:uppercase;margin-top:-6px}
.mbtn{width:100%;max-width:276px;padding:16px 18px;border:none;border-radius:12px;
  font-family:var(--fu);font-size:15px;font-weight:600;letter-spacing:.4px;
  cursor:pointer;position:relative;overflow:hidden;transition:transform .15s ease}
.mbtn::after{content:'';position:absolute;inset:0;background:rgba(255,255,255,.12);
  opacity:0;transition:opacity .15s}
.mbtn:active{transform:scale(.96)}.mbtn:active::after{opacity:1}
.btn-lang{background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.13);color:#fff;
  display:flex;align-items:center;gap:12px;justify-content:center}
.btn-lang .flag{font-size:24px}
.btn-p{background:linear-gradient(135deg,#5a28e0,#2e7de8);color:#fff;
  box-shadow:0 8px 26px rgba(90,40,224,.42)}
.btn-r{background:linear-gradient(135deg,#d42f5a,#e86c2e);color:#fff;
  box-shadow:0 8px 26px rgba(212,47,90,.32)}
.btn-ghost{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.11);
  color:#fff;font-size:13px}

/* MATCH SELECT */
.match-opt{width:100%;max-width:276px;padding:14px 16px;border:1px solid rgba(255,255,255,.12);
  border-radius:12px;background:rgba(255,255,255,.06);color:#fff;font-family:var(--fu);
  font-size:14px;font-weight:600;cursor:pointer;display:flex;align-items:center;
  gap:10px;transition:background .15s}
.match-opt:active{background:rgba(255,255,255,.14)}
.match-opt .mico{font-size:20px;flex-shrink:0}

/* GAME SCREEN */
#screen-game{flex-direction:column;justify-content:flex-start;overflow:hidden}

.game-hdr{width:100%;padding:9px 12px 6px;display:flex;align-items:center;gap:8px;
  flex-shrink:0;border-bottom:1px solid rgba(255,255,255,.06)}
.hud-back{width:30px;height:30px;border:1px solid rgba(255,255,255,.17);border-radius:8px;
  background:rgba(255,255,255,.05);color:#fff;font-size:12px;
  display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0}
.hud-lv{font-family:var(--fd);font-size:17px;letter-spacing:2px;color:#fff;flex:1;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.hud-time{font-family:var(--fh);font-size:13px;color:#fff;
  background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.1);
  border-radius:7px;padding:3px 8px;transition:color .3s,border-color .3s;flex-shrink:0}
.hud-time.warn{color:#ffaa44;border-color:rgba(255,170,68,.4)}
.hud-time.danger{color:#ff4444;border-color:rgba(255,68,68,.5);animation:tpulse .5s ease-in-out infinite}
@keyframes tpulse{0%,100%{opacity:1}50%{opacity:.45}}

/* countdown bar */
.cd-bar{width:100%;height:3px;background:rgba(255,255,255,.07);flex-shrink:0}
.cd-fill{height:100%;width:100%;background:linear-gradient(90deg,#06d6a0 0%,#ffd166 50%,#ff4444 100%);
  background-size:200% 100%;background-position:0% 50%;
  transform-origin:left;transition:width 1s linear}

/* turn banner */
.turn-ban{width:100%;padding:5px 12px;display:flex;align-items:center;gap:7px;flex-shrink:0}
.tdot{width:9px;height:9px;border-radius:50%;flex-shrink:0}
.tlbl{font-family:var(--fd);font-size:15px;letter-spacing:2px}
.tsc{font-family:var(--fh);font-size:11px;margin-left:auto;color:rgba(255,255,255,.45)}

/* stats */
.stats{width:100%;padding:5px 12px 4px;display:flex;gap:7px;flex-shrink:0}
.spill{flex:1;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);
  border-radius:8px;padding:5px 7px;text-align:center}
.slbl{font-size:7px;letter-spacing:2px;color:rgba(255,255,255,.36);
  text-transform:uppercase;display:block;margin-bottom:1px}
.sval{font-family:var(--fh);font-size:13px;color:#fff;display:block}

/* event bars */
.ebars{width:100%;padding:4px 12px 4px;display:flex;gap:8px;flex-shrink:0}
.ebar{flex:1}.elbl{font-size:7px;letter-spacing:2px;text-transform:uppercase;margin-bottom:3px;display:block}
.elbl.m{color:#ff7070}.elbl.b{color:#70ffaa}
.etrack{height:5px;background:rgba(255,255,255,.07);border-radius:3px;overflow:hidden}
.efill{height:100%;border-radius:3px;transition:width .35s cubic-bezier(.34,1.56,.64,1);width:0%}
.efill.m{background:linear-gradient(90deg,#ff4444,#ff9944)}
.efill.b{background:linear-gradient(90deg,#44ff88,#44ddff)}
.edots{display:flex;gap:3px;margin-top:3px;flex-wrap:wrap}
.edot{width:5px;height:5px;border-radius:50%;background:rgba(255,255,255,.1);
  border:1px solid rgba(255,255,255,.12);transition:all .25s ease}
.edot.mf{background:#ff6644;border-color:#ff6644;box-shadow:0 0 5px #ff6644}
.edot.bf{background:#44ff88;border-color:#44ff88;box-shadow:0 0 5px #44ff88}

/* CARD GRID */
#card-grid{flex:1;display:grid;padding:3px 9px 9px;gap:4px;
  width:100%;align-content:center;min-height:0}

/* CARD */
.card{aspect-ratio:1;perspective:700px;cursor:pointer;position:relative}
.ci{width:100%;height:100%;position:relative;transform-style:preserve-3d;
  border-radius:var(--cr);transition:transform var(--flip) cubic-bezier(.4,0,.2,1)}
.card.flipped .ci,.card.matched .ci{transform:rotateY(180deg)}
.cf{position:absolute;inset:0;backface-visibility:hidden;-webkit-backface-visibility:hidden;
  border-radius:var(--cr);display:flex;align-items:center;justify-content:center;overflow:hidden}
.cb{z-index:2;border:1px solid rgba(255,255,255,.08)}
.cb::before{content:'';position:absolute;inset:1px;border-radius:calc(var(--cr) - 1px);
  background:repeating-linear-gradient(45deg,transparent,transparent 4px,
    rgba(255,255,255,.02) 4px,rgba(255,255,255,.02) 5px)}
.cb-logo{width:50%;height:50%;object-fit:contain;opacity:.78;position:relative;z-index:1}
.cf-front{transform:rotateY(180deg);font-size:clamp(12px,3.8vw,24px);
  border:1px solid rgba(255,255,255,.09);background:rgba(255,255,255,.04)}

.card.peek .ci{transform:rotateY(180deg) scale(1.28);box-shadow:0 10px 30px rgba(0,0,0,.6)}
.card.matched .ci{animation:mpop .44s cubic-bezier(.34,1.56,.64,1) forwards}
@keyframes mpop{0%{transform:rotateY(180deg) scale(1)}40%{transform:rotateY(180deg) scale(1.13)}
  65%{transform:rotateY(180deg) scale(.97)}100%{transform:rotateY(180deg) scale(1)}}
.card.removing{animation:crem .36s ease forwards}
@keyframes crem{0%{transform:scale(1);opacity:1}100%{transform:scale(0);opacity:0}}
.card.wrong .ci{animation:shake .38s ease forwards}
@keyframes shake{0%,100%{transform:rotateY(0) translateX(0)}
  22%{transform:rotateY(0) translateX(-5px)}45%{transform:rotateY(0) translateX(5px)}
  67%{transform:rotateY(0) translateX(-4px)}88%{transform:rotateY(0) translateX(4px)}}
.card.shuffling{animation:cshuffle .44s ease forwards}
@keyframes cshuffle{0%{transform:translateY(0) rotate(0)}35%{transform:translateY(-7px) rotate(-4deg)}
  65%{transform:translateY(-3px) rotate(3deg)}100%{transform:translateY(0) rotate(0)}}
.hint-ring{position:absolute;inset:-3px;border-radius:calc(var(--cr)+3px);
  border:2px solid #44ff88;animation:hpulse .9s ease-in-out infinite;pointer-events:none;z-index:10}
@keyframes hpulse{0%,100%{box-shadow:0 0 0 0 rgba(68,255,136,.5)}50%{box-shadow:0 0 0 5px rgba(68,255,136,0)}}
@keyframes bflip{0%{transform:perspective(900px) rotateY(0)}
  50%{transform:perspective(900px) rotateY(90deg) scaleX(.88)}
  100%{transform:perspective(900px) rotateY(0)}}
#card-grid.flipping{animation:bflip .7s ease forwards}

/* OVERLAYS */
.ov{position:absolute;inset:0;z-index:200;display:flex;align-items:center;justify-content:center;
  background:rgba(0,0,0,.8);opacity:0;pointer-events:none;
  transition:opacity .3s ease;backdrop-filter:blur(5px)}
.ov.show{opacity:1;pointer-events:all}
.ovp{text-align:center;padding:26px 22px;max-width:290px;width:100%}
.ov-ico{font-size:52px;margin-bottom:8px}
.ov-ttl{font-family:var(--fd);font-size:36px;letter-spacing:3px;color:#fff;margin-bottom:5px}
.ov-dsc{font-size:12px;color:rgba(255,255,255,.5);line-height:1.5;margin-bottom:18px}
.ov-row{display:flex;gap:8px;justify-content:center;flex-wrap:wrap}
.ov-btn{padding:12px 24px;border:none;border-radius:10px;font-family:var(--fu);
  font-size:13px;font-weight:600;cursor:pointer;transition:transform .15s}
.ov-btn:active{transform:scale(.96)}
.bgrid{display:flex;flex-direction:column;gap:8px;width:100%;margin-top:4px}
.bopt{padding:11px 13px;border:1px solid rgba(255,255,255,.13);border-radius:10px;
  background:rgba(255,255,255,.06);color:#fff;font-family:var(--fu);
  cursor:pointer;display:flex;align-items:center;gap:9px;text-align:left;transition:background .15s}
.bopt:active{background:rgba(255,255,255,.13)}
.bico{font-size:20px;flex-shrink:0}
.bttl{display:block;font-size:13px;font-weight:700}
.bdsc{display:block;font-size:10px;color:rgba(255,255,255,.42);margin-top:1px}

/* LEVEL COMPLETE */
.cov{position:absolute;inset:0;z-index:400;background:rgba(0,0,0,.88);
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  opacity:0;pointer-events:none;transition:opacity .5s ease;backdrop-filter:blur(7px)}
.cov.show{opacity:1;pointer-events:all}
.cstars{font-size:42px;margin-bottom:5px;animation:spop .5s .3s cubic-bezier(.34,1.56,.64,1) both}
@keyframes spop{from{transform:scale(0);opacity:0}to{transform:scale(1);opacity:1}}
.cttl{font-family:var(--fd);font-size:50px;letter-spacing:4px;color:#fff;animation:sup .44s .4s ease both}
.csc{font-family:var(--fh);font-size:12px;color:rgba(255,255,255,.5);letter-spacing:2px;
  margin:5px 0 26px;animation:sup .44s .5s ease both}
@keyframes sup{from{transform:translateY(16px);opacity:0}to{transform:translateY(0);opacity:1}}
.cbtns{display:flex;gap:9px;animation:sup .44s .6s ease both}
.cbtn{padding:12px 18px;border:none;border-radius:10px;font-family:var(--fu);
  font-size:13px;font-weight:600;cursor:pointer;transition:transform .15s}
.cbtn:active{transform:scale(.96)}
.cbtn.p{background:linear-gradient(135deg,#5a28e0,#2e7de8);color:#fff}
.cbtn.s{background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.13);color:#fff}

/* GAME OVER */
.gov{position:absolute;inset:0;z-index:500;background:rgba(0,0,0,.92);
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  opacity:0;pointer-events:none;transition:opacity .5s ease;backdrop-filter:blur(8px)}
.gov.show{opacity:1;pointer-events:all}
.go-ico{font-size:68px;animation:goico .6s .2s cubic-bezier(.34,1.56,.64,1) both}
@keyframes goico{from{transform:scale(0) rotate(-15deg);opacity:0}to{transform:scale(1) rotate(0);opacity:1}}
.go-ttl{font-family:var(--fd);font-size:56px;letter-spacing:4px;color:#ff4444;
  text-shadow:0 0 28px rgba(255,68,68,.5);animation:sup .44s .4s ease both}
.go-sub{font-size:12px;color:rgba(255,255,255,.42);letter-spacing:2px;margin:5px 0 26px;animation:sup .44s .5s ease both}
.go-btns{display:flex;flex-direction:column;gap:9px;width:100%;max-width:210px;animation:sup .44s .6s ease both}
.go-btn{padding:13px;border:none;border-radius:10px;font-family:var(--fu);font-size:14px;
  font-weight:600;cursor:pointer;width:100%;transition:transform .15s}
.go-btn:active{transform:scale(.96)}
.go-btn.retry{background:linear-gradient(135deg,#ffd166,#ff9f1c);color:#000}
.go-btn.gmenu{background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.13);color:#fff}

/* WINNER */
.wov{position:absolute;inset:0;z-index:600;display:flex;flex-direction:column;
  align-items:center;justify-content:center;
  opacity:0;pointer-events:none;transition:opacity .4s ease}
.wov.show{opacity:1;pointer-events:all}
canvas#bc{display:block;margin:0 auto 4px}
.wttl{font-family:var(--fd);font-size:clamp(38px,10vw,54px);letter-spacing:4px;text-align:center;
  animation:wpop .55s .2s cubic-bezier(.34,1.56,.64,1) both}
@keyframes wpop{from{transform:scale(.6);opacity:0}to{transform:scale(1);opacity:1}}
.wp1{color:#4488ff;text-shadow:0 0 28px rgba(68,136,255,.6)}
.wp2{color:#ff4466;text-shadow:0 0 28px rgba(255,68,102,.6)}
.wsc{font-family:var(--fh);font-size:12px;color:rgba(255,255,255,.45);letter-spacing:2px;
  margin:7px 0 22px;text-align:center;animation:sup .4s .45s ease both}
.wrow{display:flex;gap:9px;animation:sup .4s .55s ease both}
.wbp{background:linear-gradient(135deg,#5a28e0,#2e7de8);color:#fff;padding:12px 18px;
  border:none;border-radius:10px;font-family:var(--fu);font-size:13px;font-weight:600;cursor:pointer}
.wbs{background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.13);color:#fff;
  padding:12px 18px;border-radius:10px;font-family:var(--fu);font-size:13px;font-weight:600;cursor:pointer}

/* CONFETTI */
.cfp{position:absolute;border-radius:2px;animation:cfall linear forwards;pointer-events:none;z-index:650}
@keyframes cfall{0%{transform:translateY(-20px) rotate(0);opacity:1}100%{transform:translateY(110vh) rotate(720deg);opacity:0}}

/* TOAST */
.toast{position:absolute;bottom:65px;left:50%;
  transform:translateX(-50%) translateY(14px);
  background:rgba(18,18,36,.95);border:1px solid rgba(255,255,255,.13);
  border-radius:10px;padding:8px 16px;font-size:12px;color:#fff;font-weight:600;
  white-space:nowrap;opacity:0;transition:all .3s cubic-bezier(.34,1.56,.64,1);
  pointer-events:none;z-index:300;backdrop-filter:blur(8px)}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

/* PEEK BAR */
.pkbar{position:absolute;bottom:0;left:0;right:0;height:3px;background:rgba(255,255,255,.08);z-index:500;display:none}
.pkfill{height:100%;background:linear-gradient(90deg,#44ff88,#44ddff);width:100%}

/* ARCADE INTRO */
#screen-arc{background:#060610}
.arc-logo{font-family:var(--fd);font-size:54px;letter-spacing:3px;color:#ffd166;
  text-shadow:0 0 28px rgba(255,209,102,.5)}
.arc-tag{font-size:10px;letter-spacing:3px;color:rgba(255,255,255,.38);margin-bottom:24px}
.lvrow{display:flex;align-items:center;gap:9px;padding:9px 12px;border-radius:9px;
  border:1px solid rgba(255,255,255,.1);background:rgba(255,255,255,.06);
  width:100%;max-width:276px}
.lvrow.locked{opacity:.35;border-color:rgba(255,255,255,.04)}
.lvrow-name{font-family:var(--fd);font-size:15px;letter-spacing:2px}
.lvrow-tag{margin-left:auto;font-size:13px}
</style>
</head>
<body>
<div id="app">

<!-- SPLASH -->
<div id="screen-splash" class="screen active">
  <div class="sbg"></div>
  <div class="sparks" id="sparks"></div>
  <div class="stitle" id="s-title">MEMORY<br>GAPS<span id="s-sub">Card Matching Game</span></div>
  <div class="tap" id="s-tap">TAP TO START</div>
</div>

<!-- LANGUAGE -->
<div id="screen-lang" class="screen">
  <div class="tbg" id="tbg-l"></div><div class="tov"></div>
  <div class="menu-wrap">
    <div class="mtitle">MEMORY<br>GAPS</div>
    <div class="msub" id="lbl-cl">Choose language</div>
    <button class="mbtn btn-lang" onclick="setLang('en')"><span class="flag">üá¨üáß</span> English</button>
    <button class="mbtn btn-lang" onclick="setLang('it')"><span class="flag">üáÆüáπ</span> Italiano</button>
  </div>
</div>

<!-- MODE -->
<div id="screen-mode" class="screen">
  <div class="tbg" id="tbg-m"></div><div class="tov"></div>
  <div class="menu-wrap">
    <div class="mtitle" id="m-ttl">CHOOSE MODE</div>
    <div class="msub" id="m-sub">Select your game type</div>
    <button class="mbtn btn-p" onclick="showArc()" id="btn-sp">‚ö° SINGLE PLAYER</button>
    <button class="mbtn btn-r" onclick="showMultiSel()" id="btn-mp">üÜö MULTIPLAYER</button>
  </div>
</div>

<!-- ARCADE INTRO -->
<div id="screen-arc" class="screen">
  <div class="tbg" id="tbg-a"></div><div class="tov"></div>
  <div class="menu-wrap">
    <div class="arc-logo">‚ö° ARCADE</div>
    <div class="arc-tag" id="arc-tag">BEAT THE CLOCK ‚Äî UNLOCK ALL LEVELS</div>
    <div id="arc-list" style="display:flex;flex-direction:column;gap:7px;width:100%;max-width:276px;margin-bottom:12px"></div>
    <button class="mbtn btn-p" onclick="startArcade()" id="btn-arc" style="max-width:220px">‚ñ∂ START</button>
    <button class="mbtn btn-ghost" onclick="showScreen('screen-mode')" id="btn-arc-back" style="max-width:220px">‚Üê BACK</button>
  </div>
</div>

<!-- MULTI MATCH SELECT -->
<div id="screen-multi" class="screen">
  <div class="tbg" id="tbg-mu"></div><div class="tov"></div>
  <div class="menu-wrap">
    <div class="mtitle" id="mu-ttl">MATCH TYPE</div>
    <div class="msub" id="mu-sub">How many rounds?</div>
    <button class="match-opt" onclick="startMulti(1)"><span class="mico">‚ö°</span><span id="mo1">Single Match</span></button>
    <button class="match-opt" onclick="startMulti(3)"><span class="mico">ü•ä</span><span id="mo3">Best of 3</span></button>
    <button class="match-opt" onclick="startMulti(5)"><span class="mico">üèÜ</span><span id="mo5">5 Rounds</span></button>
    <button class="mbtn btn-ghost" onclick="showScreen('screen-mode')" id="mu-back" style="max-width:276px;margin-top:6px">‚Üê BACK</button>
  </div>
</div>

<!-- GAME -->
<div id="screen-game" class="screen">
  <div class="game-hdr">
    <div class="hud-back" onclick="confirmQuit()">‚Üê</div>
    <div class="hud-lv" id="hud-lv">OCEAN</div>
    <div class="hud-time" id="hud-time">0:00</div>
  </div>
  <div class="cd-bar"><div class="cd-fill" id="cd-fill"></div></div>

  <div class="turn-ban" id="turn-ban" style="display:none">
    <div class="tdot" id="tdot"></div>
    <div class="tlbl" id="tlbl">PLAYER 1</div>
    <div class="tsc" id="tsc">0 ‚Äî 0</div>
  </div>

  <div class="stats">
    <div class="spill"><span class="slbl" id="lbl-pa">PAIRS</span><span class="sval" id="sv-pa">0/0</span></div>
    <div class="spill"><span class="slbl" id="lbl-sc">SCORE</span><span class="sval" id="sv-sc">0</span></div>
    <div class="spill"><span class="slbl" id="lbl-er">ERRORS</span><span class="sval" id="sv-er">0</span></div>
  </div>

  <div class="ebars">
    <div class="ebar">
      <span class="elbl m" id="lbl-ml">MALUS</span>
      <div class="etrack"><div class="efill m" id="mfill"></div></div>
      <div class="edots" id="mdots"></div>
    </div>
    <div class="ebar">
      <span class="elbl b" id="lbl-bn">BONUS</span>
      <div class="etrack"><div class="efill b" id="bfill"></div></div>
      <div class="edots" id="bdots"></div>
    </div>
  </div>

  <div id="card-grid"></div>

  <!-- Event overlay -->
  <div class="ov" id="ev-ov">
    <div class="ovp">
      <div class="ov-ico" id="ev-ico"></div>
      <div class="ov-ttl" id="ev-ttl"></div>
      <div class="ov-dsc" id="ev-dsc"></div>
      <div id="ev-btns"></div>
    </div>
  </div>

  <!-- Level complete -->
  <div class="cov" id="cov">
    <div class="cstars" id="cstars">‚≠ê‚≠ê‚≠ê</div>
    <div class="cttl" id="cttl">CLEARED!</div>
    <div class="csc" id="csc"></div>
    <div class="cbtns">
      <button class="cbtn p" id="btn-nxt">NEXT ‚ñ∂</button>
      <button class="cbtn s" id="btn-cmnu">MENU</button>
    </div>
  </div>

  <!-- Game over -->
  <div class="gov" id="gov">
    <div class="go-ico">üíÄ</div>
    <div class="go-ttl" id="go-ttl">YOU LOSE</div>
    <div class="go-sub" id="go-sub">TIME'S UP!</div>
    <div class="go-btns">
      <button class="go-btn retry" id="btn-retry">üîÑ TRY AGAIN</button>
      <button class="go-btn gmenu" id="btn-gomnu">‚Üê MENU</button>
    </div>
  </div>

  <!-- Winner (multi) -->
  <div class="wov" id="wov">
    <canvas id="bc" width="190" height="170"></canvas>
    <div class="wttl" id="wttl">PLAYER 1 WON!</div>
    <div class="wsc" id="wsc"></div>
    <div class="wrow" id="wrow"></div>
  </div>

  <!-- Peek bar -->
  <div class="pkbar" id="pkbar"><div class="pkfill" id="pkfill"></div></div>

  <div class="toast" id="toast"></div>
</div>

</div>

<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MEMORY GAPS  v2.0
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

// ‚îÄ‚îÄ I18N ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const T={
  en:{
    tap:'TAP TO START',cl:'Choose language',
    mode:'CHOOSE MODE',msub:'Select your game type',
    sp:'‚ö° SINGLE PLAYER',mp:'üÜö MULTIPLAYER',
    atag:'BEAT THE CLOCK ‚Äî UNLOCK ALL LEVELS',
    start:'‚ñ∂ START',back:'‚Üê BACK',
    pa:'PAIRS',sc:'SCORE',er:'ERRORS',ml:'MALUS',bn:'BONUS',
    cleared:'CLEARED!',next:'NEXT ‚ñ∂',
    slbl:(s,e,t)=>`SCORE ${s}  ¬∑  ${e} ERR  ¬∑  ${t}`,
    rot:'ROTATION!',rotd:'Board mirrors ‚Äî hidden cards swap!',
    shuf:'SHUFFLE!',shufd:'Hidden cards rearranged randomly!',
    rst:'RESET!',rstd:'Board resets. Clock keeps running!',
    bonus:'BONUS!',
    bpeek:'üëÅ Peek All',bpeekd:'See all cards for 3 seconds',
    bhint:'üí° Hint',bhintd:'Two matched-pair cards highlighted',
    bxtr:'üé≤ Extra Try',bxtrd:'Two chances to find the twin',
    ok:'OK',quitq:'Quit to menu?',quity:'QUIT',quitn:'KEEP PLAYING',
    ylose:'YOU LOSE',tup:"TIME'S UP!",retry:'üîÑ TRY AGAIN',menu:'‚Üê MENU',
    mtype:'MATCH TYPE',rounds:'How many rounds?',mo1:'Single Match',mo3:'Best of 3',mo5:'5 Rounds',
    p1:'PLAYER 1',p2:'PLAYER 2',pturn:"'S TURN",
    steal:'üéØ Steal Point',steald:"Steal opponent's next pair",
    skip:'‚è≠ Skip Turn',skipd:"Opponent skips next turn",
    dice:'üé∞ Lucky Dice',diced:'Risk it to see all cards!',
    risk:'RISK IT?',riskd:'Roll: 1 or 6 = see all for 3s!',
    accept:'ACCEPT',refuse:'REFUSE',
    rolling:'üé≤ ROLLING...',dwin:'üé∞ JACKPOT!',dlose:'üò¨ Not this time...',
    pwon:(n)=>`PLAYER ${n} WON!`,draw:'DRAW!',
    again:'PLAY AGAIN',bmenu:'‚Üê MENU',mscore:'MATCH',lv:'LEVEL',locked:'üîí',
  },
  it:{
    tap:'TAP PER INIZIARE',cl:'Scegli la lingua',
    mode:'SCEGLI MODO',msub:'Seleziona il tipo di partita',
    sp:'‚ö° GIOCATORE SINGOLO',mp:'üÜö MULTIGIOCATORE',
    atag:'BATTI IL TEMPO ‚Äî SBLOCCA I LIVELLI',
    start:'‚ñ∂ INIZIA',back:'‚Üê INDIETRO',
    pa:'COPPIE',sc:'PUNTI',er:'ERRORI',ml:'MALUS',bn:'BONUS',
    cleared:'COMPLETATO!',next:'AVANTI ‚ñ∂',
    slbl:(s,e,t)=>`PUNTI ${s}  ¬∑  ${e} ERR  ¬∑  ${t}`,
    rot:'ROTAZIONE!',rotd:'Il campo gira! Le carte cambiano posizione!',
    shuf:'RIMESCOLATE!',shufd:'Le carte coperte riposizionate!',
    rst:'RESET!',rstd:'Il campo riparte. Il tempo continua!',
    bonus:'BONUS!',
    bpeek:'üëÅ Svela Tutto',bpeekd:'Vedi tutte le carte per 3 secondi',
    bhint:'üí° Suggerimento',bhintd:'Due carte suggerite',
    bxtr:'üé≤ Extra',bxtrd:'Due tentativi per trovare la gemella',
    ok:'OK',quitq:'Tornare al menu?',quity:'ESCI',quitn:'CONTINUA',
    ylose:'HAI PERSO',tup:'TEMPO SCADUTO!',retry:'üîÑ RIPROVA',menu:'‚Üê MENU',
    mtype:'TIPO MATCH',rounds:'Quanti round?',mo1:'Match Singolo',mo3:'Al meglio dei 3',mo5:'5 Round',
    p1:'GIOCATORE 1',p2:'GIOCATORE 2',pturn:' ‚Äî IL TUO TURNO',
    steal:'üéØ Ruba Punto',steald:"Ruba la coppia all'avversario",
    skip:'‚è≠ Salta Turno',skipd:"L'avversario salta il turno",
    dice:'üé∞ Dado',diced:'Rischia per vedere tutto!',
    risk:'RISCHI?',riskd:'1 o 6 = vedi tutto per 3s!',
    accept:'ACCETTA',refuse:'RIFIUTA',
    rolling:'üé≤ IN ROLL...',dwin:'üé∞ JACKPOT!',dlose:'üò¨ Peccato...',
    pwon:(n)=>`GIOCATORE ${n} HA VINTO!`,draw:'PAREGGIO!',
    again:'GIOCA ANCORA',bmenu:'‚Üê MENU',mscore:'MATCH',lv:'LIVELLO',locked:'üîí',
  }
};
let lang='en',L=T.en;
function setLang(l){lang=l;L=T[l];applyLang();showScreen('screen-mode')}
function applyLang(){
  ['s-tap','lbl-cl'].forEach(id=>{const el=document.getElementById(id);if(!el)return;
    el.textContent=({s_tap:L.tap,'lbl-cl':L.cl})[id]||''});
  setT('m-ttl',L.mode);setT('m-sub',L.msub);setT('btn-sp',L.sp);setT('btn-mp',L.mp);
  setT('arc-tag',L.atag);setT('btn-arc',L.start);setT('btn-arc-back',L.back);
  setT('mu-ttl',L.mtype);setT('mu-sub',L.rounds);
  setT('mo1',L.mo1);setT('mo3',L.mo3);setT('mo5',L.mo5);setT('mu-back',L.back);
  setT('lbl-pa',L.pa);setT('lbl-sc',L.sc);setT('lbl-er',L.er);
  setT('lbl-ml',L.ml);setT('lbl-bn',L.bn);
  setT('go-ttl',L.ylose);setT('go-sub',L.tup);
  setT('btn-retry',L.retry);setT('btn-gomnu',L.menu);
  buildArcList();
}
function setT(id,v){const el=document.getElementById(id);if(el&&v!==undefined)el.textContent=v}

// ‚îÄ‚îÄ LEVELS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const BACK='https://raw.githubusercontent.com/giadaanni/Memory-gaps/main/asset/Back_card.svg';
const LVS=[
  {id:1,name:'OCEAN',emo:'üåä',cols:2,rows:2,tl:45,ma:0,bo:0,
   em:['üê†','ü¶à'],bg:'#020d1a',b1:'#0a2a4a',b2:'#051828',ac:'#00b4d8'},
  {id:2,name:'FOREST',emo:'üåø',cols:3,rows:2,tl:60,ma:5,bo:4,
   em:['üå≤','üçÑ','ü¶ä'],bg:'#030f06',b1:'#0a3015',b2:'#061a09',ac:'#52b788'},
  {id:3,name:'FOOD',emo:'üçï',cols:4,rows:3,tl:90,ma:5,bo:3,
   em:['üçï','üç£','üç©','ü•ë','üçî','üåÆ'],bg:'#1a0800',b1:'#3d1200',b2:'#220900',ac:'#ff6b35'},
  {id:4,name:'SPACE',emo:'üöÄ',cols:4,rows:4,tl:120,ma:4,bo:3,
   em:['üöÄ','üåô','‚≠ê','ü™ê','üëæ','‚òÑÔ∏è','üõ∏','üåå'],bg:'#05020f',b1:'#1a0a3a',b2:'#0d0520',ac:'#9d4edd'},
  {id:5,name:'MOOD',emo:'üòé',cols:5,rows:4,tl:150,ma:4,bo:3,
   em:['üòÇ','üòç','ü§Ø','üòé','ü•≥','üò±','ü•∫','üò¥','ü§©','üò§'],bg:'#1a1000',b1:'#3a2500',b2:'#201500',ac:'#ffd166'},
  {id:6,name:'SPORTS',emo:'üèÜ',cols:6,rows:4,tl:180,ma:3,bo:2,
   em:['‚öΩ','üéæ','üèÄ','üéØ','üèä','üö¥','üèãÔ∏è','ü§∫','üèÑ','‚õ∑Ô∏è','ü§∏','üé≥'],bg:'#001a08',b1:'#003015',b2:'#001a09',ac:'#06d6a0'},
  {id:7,name:'ANIMALS',emo:'ü¶Å',cols:7,rows:4,tl:210,ma:3,bo:2,
   em:['ü¶Å','üêò','ü¶í','üêº','ü¶ã','ü¶ú','üê¨','ü¶ä','üê∏','üêß','ü¶Ä','ü¶ô','üêç','ü¶Ö'],bg:'#150a00',b1:'#2d1500',b2:'#1a0c00',ac:'#e07a40'},
  {id:8,name:'MUSIC',emo:'üé∏',cols:8,rows:6,tl:300,ma:3,bo:2,
   em:['üé∏','üé∫','üéª','ü•Å','üéπ','üé∑','üé§','üéµ','üéß','üìª','ü™ó','ü™ò',
       'üéº','üéôÔ∏è','üîä','üéöÔ∏è','üéõÔ∏è','ü™à','üé∂','üéÉ','üé®','üé≠','üé™','üéØ'],
   bg:'#050010',b1:'#160030',b2:'#0a0020',ac:'#ff00ff'},
];

// Multiplayer skins (cycle per round)
const MSKINS=[
  {bg:'#020d1a',b1:'#0a2a4a',b2:'#051828',ac:'#00b4d8'},
  {bg:'#1a0800',b1:'#3d1200',b2:'#220900',ac:'#ff6b35'},
  {bg:'#050010',b1:'#160030',b2:'#0a0020',ac:'#ff00ff'},
  {bg:'#001a08',b1:'#003015',b2:'#001a09',ac:'#06d6a0'},
  {bg:'#150800',b1:'#3a1800',b2:'#200e00',ac:'#ffd166'},
];

// ‚îÄ‚îÄ UNLOCKS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getUn(){try{return JSON.parse(localStorage.getItem('mg_un')||'[1]')}catch{return[1]}}
function addUn(id){const u=getUn();if(!u.includes(id)){u.push(id);localStorage.setItem('mg_un',JSON.stringify(u))}}
function isUn(id){return getUn().includes(id)}

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const G={
  mode:'sp',lv:null,cards:[],flip:[],
  matched:0,total:0,score:0,errors:0,
  timer:0,tl:0,tInt:null,
  mc:0,bc:0,                  // malus/bonus counters (streak-based)
  streakOk:0,streakFail:0,
  locked:false,
  hintIds:[],extraTry:false,peekTO:null,
  // multi
  cur:0,pPairs:[0,0],
  skipNxt:false,stealAct:false,
  totalRounds:1,curRound:1,rWins:[0,0],
  skin:0,
};

// ‚îÄ‚îÄ TILED BG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildTiled(id){
  const el=document.getElementById(id);if(!el)return;
  const W=Math.min(window.innerWidth,430),H=window.innerHeight;
  const cs=48,gap=4;
  const cols=Math.ceil(W/(cs+gap)),rows=Math.ceil(H/(cs+gap));
  el.style.gridTemplateColumns=`repeat(${cols},${cs}px)`;
  el.style.gridTemplateRows=`repeat(${rows},${cs}px)`;
  const pool=LVS.flatMap(l=>l.em);
  el.innerHTML='';
  for(let i=0;i<cols*rows;i++){
    const d=document.createElement('div');d.className='tbc';
    if(Math.random()>.42)d.textContent=pool[Math.floor(Math.random()*pool.length)];
    el.appendChild(d);
  }
}

// ‚îÄ‚îÄ SPLASH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function initSplash(){
  const c=document.getElementById('sparks');
  for(let i=0;i<32;i++){
    const s=document.createElement('div');s.className='spark';
    s.style.left=Math.random()*100+'%';
    const sz=(Math.random()*3+1)+'px';s.style.width=s.style.height=sz;
    s.style.animationDuration=(Math.random()*7+4)+'s';
    s.style.animationDelay=(Math.random()*7)+'s';
    s.style.background=`hsl(${Math.random()*60+260},80%,80%)`;
    c.appendChild(s);
  }
}

// ‚îÄ‚îÄ NAV ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showScreen(id){
  document.querySelectorAll('.screen.active').forEach(s=>s.classList.remove('active'));
  const el=document.getElementById(id);if(!el)return;
  el.classList.add('active');
  if(id==='screen-lang')buildTiled('tbg-l');
  if(id==='screen-mode'){buildTiled('tbg-m');applyLang()}
  if(id==='screen-arc'){buildTiled('tbg-a');buildArcList()}
  if(id==='screen-multi'){buildTiled('tbg-mu');applyLang()}
}

// ‚îÄ‚îÄ ARCADE LIST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildArcList(){
  const el=document.getElementById('arc-list');if(!el)return;
  el.innerHTML='';
  const un=getUn();
  LVS.forEach(lv=>{
    const open=un.includes(lv.id);
    const d=document.createElement('div');
    d.className='lvrow'+(open?'':' locked');
    d.innerHTML=`<span style="font-size:18px">${lv.emo}</span>
      <span class="lvrow-name" style="color:${open?'#fff':'rgba(255,255,255,.4)'};font-family:'Bebas Neue',sans-serif;font-size:15px;letter-spacing:2px">
        ${L.lv} ${lv.id} ‚Äî ${lv.name}
      </span>
      <span class="lvrow-tag">${open?lv.ac:'üîí'}</span>`;
    if(open)d.style.borderColor=lv.ac+'55';
    el.appendChild(d);
  });
}
function showArc(){showScreen('screen-arc')}
function startArcade(){
  const un=getUn();
  const maxId=Math.max(...un);
  const lv=LVS.find(l=>l.id===maxId)||LVS[0];
  G.mode='sp';startGame(lv);
}
function showMultiSel(){showScreen('screen-multi')}
function startMulti(n){
  G.mode='mp';G.totalRounds=n;G.curRound=1;G.rWins=[0,0];
  G.pPairs=[0,0];G.cur=0;G.skin=0;
  startGame(LVS[7]);
}

// ‚îÄ‚îÄ GAME START ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function startGame(lv){
  G.lv=lv;G.cards=[];G.flip=[];
  G.matched=0;G.total=(lv.cols*lv.rows)/2;
  G.score=0;G.errors=0;G.timer=0;
  G.mc=0;G.bc=0;G.streakOk=0;G.streakFail=0;
  G.locked=false;G.hintIds=[];G.extraTry=false;
  G.skipNxt=false;G.stealAct=false;
  if(G.tInt)clearInterval(G.tInt);

  let sk=lv;
  if(G.mode==='mp'){const s=MSKINS[G.skin%MSKINS.length];sk={...lv,...s}}

  document.getElementById('screen-game').style.background=sk.bg;
  document.getElementById('hud-lv').textContent=
    G.mode==='mp'?`${sk.name||LVS[7].name} R${G.curRound}/${G.totalRounds}`:lv.name;

  // timer display
  G.tl=G.mode==='sp'?lv.tl:0;
  const cf=document.getElementById('cd-fill');
  cf.style.transition='none';
  cf.style.width=G.mode==='sp'?'100%':'0';
  cf.style.backgroundPosition='0% 50%';
  document.getElementById('hud-time').className='hud-time';

  // turn banner
  const tb=document.getElementById('turn-ban');
  tb.style.display=G.mode==='mp'?'flex':'none';
  if(G.mode==='mp')updateTurnBan();

  buildBars(lv);buildGrid(sk);updateHUD();

  // hide overlays
  ['ev-ov','cov','gov','wov'].forEach(id=>document.getElementById(id).classList.remove('show'));
  document.getElementById('pkbar').style.display='none';

  showScreen('screen-game');
  setTimeout(()=>{
    cf.style.transition='';
    G.tInt=setInterval(tick,1000);
  },350);
}

// ‚îÄ‚îÄ TICK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function tick(){
  G.timer++;
  const hel=document.getElementById('hud-time');
  if(G.mode==='sp'){
    const rem=Math.max(0,G.tl-G.timer);
    const m=Math.floor(rem/60),s=rem%60;
    hel.textContent=`${m}:${s.toString().padStart(2,'0')}`;
    hel.className='hud-time'+(rem<=10?' danger':rem<=30?' warn':'');
    const pct=(rem/G.tl)*100;
    const cf=document.getElementById('cd-fill');
    cf.style.width=pct+'%';
    cf.style.backgroundPosition=`${100-pct}% 50%`;
    if(rem<=0){clearInterval(G.tInt);doGameOver()}
  } else {
    const m=Math.floor(G.timer/60),s=G.timer%60;
    hel.textContent=`${m}:${s.toString().padStart(2,'0')}`;
  }
}

function doGameOver(){
  G.locked=true;
  document.getElementById('gov').classList.add('show');
  document.getElementById('btn-retry').onclick=()=>{
    document.getElementById('gov').classList.remove('show');startGame(G.lv)};
  document.getElementById('btn-gomnu').onclick=()=>{
    document.getElementById('gov').classList.remove('show');showScreen('screen-mode')};
}

// ‚îÄ‚îÄ TURN BANNER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateTurnBan(){
  const cols=['#4488ff','#ff4466'];
  const nm=[L.p1,L.p2];
  const el=document.getElementById('tdot');el.style.background=cols[G.cur];
  const tl=document.getElementById('tlbl');
  tl.textContent=nm[G.cur]+(L.pturn||"'S TURN");
  tl.style.color=cols[G.cur];
  document.getElementById('tsc').textContent=`${G.pPairs[0]} ‚Äî ${G.pPairs[1]}`;
}

// ‚îÄ‚îÄ EVENT BARS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildBars(lv){
  const md=document.getElementById('mdots'),bd=document.getElementById('bdots');
  md.innerHTML='';bd.innerHTML='';
  const mm=lv.ma||1,bm=lv.bo||1;
  for(let i=0;i<mm;i++){const d=document.createElement('div');d.className='edot';d.id=`md${i}`;md.appendChild(d)}
  for(let i=0;i<bm;i++){const d=document.createElement('div');d.className='edot';d.id=`bd${i}`;bd.appendChild(d)}
  updateBars();
}
function updateBars(){
  const lv=G.lv;if(!lv)return;
  const mm=lv.ma||1,bm=lv.bo||1;
  for(let i=0;i<mm;i++){const d=document.getElementById(`md${i}`);if(d)d.className='edot'+(i<G.mc?' mf':'')}
  document.getElementById('mfill').style.width=`${Math.min((G.mc/mm)*100,100)}%`;
  for(let i=0;i<bm;i++){const d=document.getElementById(`bd${i}`);if(d)d.className='edot'+(i<G.bc?' bf':'')}
  document.getElementById('bfill').style.width=`${Math.min((G.bc/bm)*100,100)}%`;
}

// ‚îÄ‚îÄ GRID ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildGrid(sk){
  const lv=G.lv;
  const grid=document.getElementById('card-grid');
  grid.style.gridTemplateColumns=`repeat(${lv.cols},1fr)`;
  grid.innerHTML='';G.cards=[];
  const pairs=[];
  for(let i=0;i<G.total;i++){const e=lv.em[i%lv.em.length];pairs.push(e,e)}
  shuffle(pairs);
  pairs.forEach((e,idx)=>{
    const card={idx,e,el:null,flipped:false,matched:false};
    const el=document.createElement('div');el.className='card';el.dataset.idx=idx;
    el.innerHTML=`<div class="ci">
      <div class="cf cb" style="background:linear-gradient(135deg,${sk.b1},${sk.b2})">
        <img class="cb-logo" src="${BACK}" alt="" onerror="this.style.display='none'">
      </div>
      <div class="cf cf-front">${e}</div>
    </div>`;
    el.addEventListener('click',()=>onCard(idx));
    card.el=el;G.cards.push(card);grid.appendChild(el);
  });
}
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a}

// ‚îÄ‚îÄ CARD CLICK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function onCard(idx){
  if(G.locked)return;
  const c=G.cards[idx];
  if(!c||c.flipped||c.matched)return;
  if(G.flip.length>=2)return;
  if(G.flip.length===1&&G.flip[0]===idx)return;
  c.flipped=true;c.el.classList.add('flipped','peek');
  G.flip.push(idx);
  setTimeout(()=>c.el.classList.remove('peek'),520);
  if(G.flip.length===2){G.locked=true;setTimeout(evalPair,660)}
}

function evalPair(){
  const [a,b]=G.flip.map(i=>G.cards[i]);
  if(a.e===b.e)doMatch(a,b);else doMiss(a,b);
  G.flip=[];
}

// ‚îÄ‚îÄ MATCH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function doMatch(a,b){
  a.matched=b.matched=true;
  a.el.classList.add('matched');b.el.classList.add('matched');
  G.matched++;G.streakOk++;G.streakFail=0;
  G.score+=100+Math.max(0,25-G.timer);

  if(G.mode==='mp'){
    if(G.stealAct){
      const opp=1-G.cur;
      if(G.pPairs[opp]>0){G.pPairs[opp]--;G.pPairs[G.cur]++}else G.pPairs[G.cur]++;
      G.stealAct=false;toast('üéØ STOLEN!');
    }else G.pPairs[G.cur]++;
    updateTurnBan();
  }

  setTimeout(()=>{
    a.el.classList.add('removing');b.el.classList.add('removing');
    setTimeout(()=>{
      a.el.style.visibility='hidden';b.el.style.visibility='hidden';
      a.el.classList.remove('removing');b.el.classList.remove('removing');
    },370);
  },460);

  clearHints();G.extraTry=false;

  // BONUS: streak counter increments on match; resets on miss
  const lv=G.lv;
  if(lv.bo>0){
    G.bc++;
    if(G.bc>=lv.bo){
      G.bc=0;updateBars();
      setTimeout(()=>{
        if(G.matched>=G.total)return; // don't show bonus if game over
        doBonus();
      },860);
      updateHUD();return;
    }
  }
  updateBars();updateHUD();
  setTimeout(()=>{G.locked=false;checkWin()},860);
}

// ‚îÄ‚îÄ MISS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function doMiss(a,b){
  a.el.classList.add('wrong');b.el.classList.add('wrong');
  G.errors++;G.streakFail++;G.streakOk=0;
  // ‚òÖ FIX [1]: bonus bar RESETS on miss
  G.bc=0;
  updateBars();updateHUD();

  setTimeout(()=>{
    a.el.classList.remove('wrong');b.el.classList.remove('wrong');
    a.flipped=false;b.flipped=false;
    a.el.classList.remove('flipped');b.el.classList.remove('flipped');

    const lv=G.lv;
    if(lv.ma>0){
      G.mc++;
      if(G.mc>=lv.ma){
        G.mc=0;updateBars();
        // ‚òÖ FIX [1]: malus bar resets when malus triggers (correct move before full resets it via bc=0 path)
        setTimeout(doMalus,180);return;
      }
    }
    // ‚òÖ FIX [1]: if correct BEFORE malus bar is full ‚Üí malus bar resets
    // (malus bar already reset because we let it clear next match via mc not changing ‚Äî handled here:
    //  no reset needed, mc just doesn't reach threshold)
    updateBars();

    if(G.mode==='mp'){
      if(G.skipNxt){
        G.skipNxt=false;
        toast(`‚è≠ ${G.cur===0?L.p2:L.p1} SKIPPED`);
        // current player stays for this turn (opponent skipped)
      }else{
        G.cur=1-G.cur;updateTurnBan();
        toast((G.cur===0?L.p1:L.p2)+(L.pturn||"'S TURN"));
      }
    }
    G.locked=false;
  },920);
}

function updateHUD(){
  document.getElementById('sv-pa').textContent=`${G.matched}/${G.total}`;
  document.getElementById('sv-sc').textContent=G.mode==='mp'?`${G.pPairs[0]}¬∑${G.pPairs[1]}`:G.score;
  document.getElementById('sv-er').textContent=G.errors;
}

// ‚îÄ‚îÄ MALUS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const MPOOL=['rotation','shuffle','reset'];
function doMalus(){
  const type=MPOOL[Math.floor(Math.random()*MPOOL.length)];
  G.locked=true;
  const cfg={
    rotation:{ico:'üîÑ',t:()=>L.rot,d:()=>L.rotd},
    shuffle: {ico:'üé≤',t:()=>L.shuf,d:()=>L.shufd},
    reset:   {ico:'üí•',t:()=>L.rst,d:()=>L.rstd},
  }[type];
  showOv(cfg.ico,cfg.t(),cfg.d(),[{lbl:L.ok,
    style:'background:linear-gradient(135deg,#d42f5a,#e86c2e);color:#fff;',
    fn:()=>{hideOv();execMalus(type)}}]);
}
function execMalus(type){
  const grid=document.getElementById('card-grid');
  if(type==='rotation'){
    grid.classList.add('flipping');
    setTimeout(()=>{mirrorBoard();grid.classList.remove('flipping');G.locked=false},700);
  }else if(type==='shuffle'){
    animShuffle(()=>{shuffleHid();G.locked=false});
  }else{
    animShuffle(()=>{resetBoard()});
  }
  // malus resets streakOk ‚Üí bonus bar already at 0 (miss caused bc=0)
}
function mirrorBoard(){
  const u=G.cards.filter(c=>!c.matched&&!c.flipped);
  const em=u.map(c=>c.e).reverse();
  u.forEach((c,i)=>{c.e=em[i];c.el.querySelector('.cf-front').textContent=em[i]});
}
function shuffleHid(){
  const u=G.cards.filter(c=>!c.matched&&!c.flipped);
  const em=shuffle(u.map(c=>c.e));
  u.forEach((c,i)=>{c.e=em[i];c.el.querySelector('.cf-front').textContent=em[i]});
}
function resetBoard(){
  const all=G.cards.filter(c=>!c.matched);
  const em=shuffle(all.map(c=>c.e));
  all.forEach((c,i)=>{
    c.e=em[i];c.el.querySelector('.cf-front').textContent=em[i];
    if(c.flipped){c.flipped=false;c.el.classList.remove('flipped')}
  });
  G.flip=[];G.score=Math.max(0,G.score-150);updateHUD();G.locked=false;
}
function animShuffle(cb){
  const u=G.cards.filter(c=>!c.matched&&!c.flipped);
  u.forEach((c,i)=>{c.el.classList.add('shuffling');c.el.style.animationDelay=(i*.04)+'s'});
  setTimeout(()=>{u.forEach(c=>c.el.classList.remove('shuffling'));cb()},540);
}

// ‚îÄ‚îÄ BONUS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function doBonus(){
  G.locked=true;
  if(G.mode==='sp'){
    // ‚òÖ FIX [4]: random in single player
    const pool=['peek','hint','extra'];
    const chosen=pool[Math.floor(Math.random()*pool.length)];
    const lbl={peek:L.bpeek,hint:L.bhint,extra:L.bxtr}[chosen];
    toast('‚ú® '+lbl);
    setTimeout(()=>execBonus(chosen),200);
  }else{
    // ‚òÖ Multiplayer: player chooses
    const opts=[
      {ico:'üëÅ',t:L.bpeek,d:L.bpeekd,v:'peek',c:'rgba(68,255,136,.14)',bc:'rgba(68,255,136,.4)',tc:'#44ff88'},
      {ico:'üí°',t:L.bhint,d:L.bhintd,v:'hint',c:'rgba(68,221,255,.14)',bc:'rgba(68,221,255,.4)',tc:'#44ddff'},
      {ico:'üéØ',t:L.steal,d:L.steald,v:'steal',c:'rgba(255,170,68,.14)',bc:'rgba(255,170,68,.4)',tc:'#ffaa44'},
      {ico:'‚è≠',t:L.skip,d:L.skipd,v:'skip',c:'rgba(200,68,255,.14)',bc:'rgba(200,68,255,.4)',tc:'#cc44ff'},
      {ico:'üé∞',t:L.dice,d:L.diced,v:'dice',c:'rgba(255,68,68,.14)',bc:'rgba(255,68,68,.4)',tc:'#ff8888'},
    ];
    showBonusPick(L.bonus,opts,v=>{hideOv();execBonus(v)});
  }
}

function showBonusPick(title,opts,cb){
  document.getElementById('ev-ico').textContent='‚ú®';
  document.getElementById('ev-ttl').textContent=title;
  document.getElementById('ev-dsc').textContent='';
  const btns=document.getElementById('ev-btns');btns.innerHTML='';
  const grid=document.createElement('div');grid.className='bgrid';
  opts.forEach(o=>{
    const b=document.createElement('button');b.className='bopt';
    b.style.cssText=`background:${o.c};border-color:${o.bc};`;
    b.innerHTML=`<span class="bico">${o.ico}</span>
      <span><span class="bttl" style="color:${o.tc}">${o.t}</span>
      <span class="bdsc">${o.d}</span></span>`;
    b.addEventListener('click',()=>cb(o.v));
    grid.appendChild(b);
  });
  btns.appendChild(grid);
  document.getElementById('ev-ov').classList.add('show');
}

function execBonus(type){
  if(type==='peek'){
    // ‚òÖ FIX [2]: cards flip, then flip back after 3s, locked during peek
    const hidden=G.cards.filter(c=>!c.matched&&!c.flipped);
    hidden.forEach(c=>c.el.classList.add('flipped'));
    G.locked=true;
    const bar=document.getElementById('pkbar'),fill=document.getElementById('pkfill');
    bar.style.display='block';
    fill.style.transition='none';fill.style.width='100%';
    requestAnimationFrame(()=>requestAnimationFrame(()=>{
      fill.style.transition='width 3s linear';fill.style.width='0%';
    }));
    if(G.peekTO)clearTimeout(G.peekTO);
    G.peekTO=setTimeout(()=>{
      // ‚òÖ FIX [2]: only remove flip from cards that weren't in G.flip buffer
      hidden.forEach(c=>{
        if(!G.flip.includes(c.idx)){c.el.classList.remove('flipped');c.flipped=false}
      });
      bar.style.display='none';fill.style.transition='none';fill.style.width='100%';
      G.locked=false;
      checkWin(); // ‚òÖ FIX [5]: check win after peek ends
    },3000);
  }else if(type==='hint'){
    const u=G.cards.filter(c=>!c.matched&&!c.flipped);
    const em={};u.forEach(c=>{if(!em[c.e])em[c.e]=[];em[c.e].push(c)});
    const pairs=Object.values(em).filter(p=>p.length>=2);
    if(!pairs.length){G.locked=false;return}
    const pair=pairs[Math.floor(Math.random()*pairs.length)];
    G.hintIds=[pair[0].idx,pair[1].idx];
    G.hintIds.forEach(i=>{
      const r=document.createElement('div');r.className='hint-ring';r.id=`hr${i}`;
      G.cards[i].el.appendChild(r);
    });
    toast('üí° '+L.bhint);G.locked=false;
  }else if(type==='extra'){
    G.extraTry=true;toast('üé≤ '+L.bxtr);G.locked=false;
  }else if(type==='steal'){
    G.stealAct=true;toast('üéØ '+L.steal);G.locked=false;
  }else if(type==='skip'){
    G.skipNxt=true;toast('‚è≠ '+L.skip);G.locked=false;
  }else if(type==='dice'){
    showOv('üé∞',L.risk,L.riskd,[
      {lbl:L.accept,style:'background:linear-gradient(135deg,#ffd166,#ff9f1c);color:#000;',
        fn:()=>{hideOv();rollDice()}},
      {lbl:L.refuse,style:'background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.14);color:#fff;',
        fn:()=>{hideOv();G.locked=false}},
    ]);
  }
}

function rollDice(){
  G.locked=true;
  showOv('üé≤',L.rolling,'!',[]);
  setTimeout(()=>{
    const r=Math.floor(Math.random()*6)+1;
    const win=r===1||r===6;
    hideOv();toast(`üé≤ ${r} ‚Äî ${win?L.dwin:L.dlose}`);
    if(win){execBonus('peek')}else{G.locked=false}
  },1200);
}

function clearHints(){
  document.querySelectorAll('.hint-ring').forEach(r=>r.remove());G.hintIds=[];
}

// ‚îÄ‚îÄ GENERIC OVERLAY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showOv(ico,ttl,dsc,btns){
  document.getElementById('ev-ico').textContent=ico;
  document.getElementById('ev-ttl').textContent=ttl;
  document.getElementById('ev-dsc').textContent=dsc;
  const el=document.getElementById('ev-btns');el.innerHTML='';
  const row=document.createElement('div');row.className='ov-row';
  btns.forEach(b=>{
    const btn=document.createElement('button');btn.className='ov-btn';
    btn.style.cssText=b.style||'background:rgba(255,255,255,.09);border:1px solid rgba(255,255,255,.14);color:#fff;';
    btn.textContent=b.lbl;btn.addEventListener('click',b.fn);
    row.appendChild(btn);
  });
  el.appendChild(row);
  document.getElementById('ev-ov').classList.add('show');
}
function hideOv(){document.getElementById('ev-ov').classList.remove('show')}

// ‚îÄ‚îÄ WIN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function checkWin(){
  if(G.matched<G.total)return;
  clearInterval(G.tInt);
  if(G.mode==='sp'){showComplete();addUn(G.lv.id+1)}
  else showRoundEnd();
}

function showComplete(){
  // ‚òÖ FIX [5]: game actually ends now
  const m=Math.floor(G.timer/60),s=G.timer%60;
  const t=`${m}:${s.toString().padStart(2,'0')}`;
  const er=G.errors/G.total;
  document.getElementById('cstars').textContent=er<0.3?'‚≠ê‚≠ê‚≠ê':er<0.7?'‚≠ê‚≠ê':'‚≠ê';
  document.getElementById('cttl').textContent=L.cleared;
  document.getElementById('csc').textContent=L.slbl(G.score,G.errors,t);
  const nxtLv=LVS.find(l=>l.id===G.lv.id+1);
  const nb=document.getElementById('btn-nxt');
  if(nxtLv){nb.textContent=L.next;nb.onclick=()=>{document.getElementById('cov').classList.remove('show');startGame(nxtLv)}}
  else{nb.textContent='üèÜ THE END!';nb.onclick=()=>showScreen('screen-mode')}
  document.getElementById('btn-cmnu').textContent=L.menu;
  document.getElementById('btn-cmnu').onclick=()=>{document.getElementById('cov').classList.remove('show');showScreen('screen-mode')};
  setTimeout(()=>{document.getElementById('cov').classList.add('show');spawnConf(40)},550);
}

// ‚îÄ‚îÄ MULTI ROUND/MATCH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showRoundEnd(){
  const p0=G.pPairs[0],p1=G.pPairs[1];
  let w=-1;if(p0>p1)w=0;else if(p1>p0)w=1;
  if(w>=0)G.rWins[w]++;
  const isLast=G.curRound>=G.totalRounds;
  if(!isLast){
    G.curRound++;G.skin++;G.pPairs=[0,0];G.cur=0;
    const nm=[L.p1,L.p2];
    const ttl=w>=0?`${nm[w]} WON R${G.curRound-1}!`:'ROUND DRAW!';
    showOv(w===0?'üíô':w===1?'‚ù§Ô∏è':'ü§ù',ttl,`${L.mscore}: ${G.rWins[0]} ‚Äî ${G.rWins[1]}`,[
      {lbl:'NEXT ROUND ‚ñ∂',style:'background:linear-gradient(135deg,#5a28e0,#2e7de8);color:#fff;',
        fn:()=>{hideOv();startGame(LVS[7])}}]);
  }else showMatchWin()
}

function showMatchWin(){
  const rw=G.rWins;
  let w=-1;if(rw[0]>rw[1])w=0;else if(rw[1]>rw[0])w=1;
  const wov=document.getElementById('wov');
  wov.style.background=w===0?'radial-gradient(ellipse at 50% 38%,#0d1a4a,#000 70%)':
    w===1?'radial-gradient(ellipse at 50% 38%,#3a0d1a,#000 70%)':
    'radial-gradient(ellipse at 50% 38%,#1a1a1a,#000 70%)';
  const wt=document.getElementById('wttl');
  if(w>=0){wt.textContent=L.pwon(w+1);wt.className='wttl '+(w===0?'wp1':'wp2')}
  else{wt.textContent=L.draw;wt.className='wttl';wt.style.color='#fff'}
  document.getElementById('wsc').textContent=`${L.mscore}: ${rw[0]} ‚Äî ${rw[1]}`;
  const wr=document.getElementById('wrow');wr.innerHTML='';
  const b1=document.createElement('button');b1.className='wbp';b1.textContent=L.again;
  b1.onclick=()=>{wov.classList.remove('show');G.rWins=[0,0];G.curRound=1;G.skin=0;G.pPairs=[0,0];G.cur=0;startGame(LVS[7])};
  const b2=document.createElement('button');b2.className='wbs';b2.textContent=L.bmenu;
  b2.onclick=()=>{wov.classList.remove('show');showScreen('screen-mode')};
  wr.appendChild(b1);wr.appendChild(b2);
  animBrain(w);
  setTimeout(()=>{wov.classList.add('show');spawnConf(90)},180);
}

// ‚îÄ‚îÄ BRAIN CANVAS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function animBrain(w){
  const cv=document.getElementById('bc'),ctx=cv.getContext('2d');
  const W=cv.width,H=cv.height,cx=W/2,cy=H/2;
  if(cv._aid)cancelAnimationFrame(cv._aid);
  const hue=w===0?220:w===1?340:200;
  let f=0;
  const VBASE=[ // base brain silhouette vertices (offsets from center)
    [0,-48],[28,-40],[48,-20],[50,5],[38,28],[18,44],
    [-4,48],[-26,38],[-48,16],[-50,-10],[-38,-32],[-16,-46]
  ];
  function draw(){
    ctx.clearRect(0,0,W,H);
    const sc=0.9+Math.sin(f*.055)*.1;
    const rot=f*.012;
    // draw low-poly brain
    const verts=VBASE.map(([x,y])=>{
      const r=Math.sqrt(x*x+y*y)*sc;
      const a=Math.atan2(y,x)+rot;
      return[cx+Math.cos(a)*r,cy+Math.sin(a)*r+10];
    });
    // triangulate fan style
    for(let i=0;i<verts.length;i++){
      const j=(i+1)%verts.length;
      const li=30+((i*18)%40);
      ctx.fillStyle=`hsl(${hue+i*5},60%,${li}%)`;
      ctx.strokeStyle=`hsl(${hue},70%,55%)`;
      ctx.lineWidth=.8;
      ctx.beginPath();
      ctx.moveTo(cx,cy+10);
      ctx.lineTo(verts[i][0],verts[i][1]);
      ctx.lineTo(verts[j][0],verts[j][1]);
      ctx.closePath();ctx.fill();ctx.stroke();
    }
    // crown (fixed at top, above brain)
    const crx=cx,cry=cy-44*sc;
    ctx.fillStyle='#ffd700';
    ctx.beginPath();
    ctx.moveTo(crx-20,cry+8);
    ctx.lineTo(crx-20,cry-6);
    ctx.lineTo(crx-10,cry+2);
    ctx.lineTo(crx,cry-12);
    ctx.lineTo(crx+10,cry+2);
    ctx.lineTo(crx+20,cry-6);
    ctx.lineTo(crx+20,cry+8);
    ctx.closePath();ctx.fill();
    ctx.strokeStyle='#b8860b';ctx.lineWidth=1;ctx.stroke();
    // gems on crown
    [[crx-20,cry-6],[crx,cry-12],[crx+20,cry-6]].forEach(([x,y])=>{
      ctx.beginPath();ctx.arc(x,y,2.5,0,Math.PI*2);
      ctx.fillStyle=w===0?'#4488ff':w===1?'#ff4466':'#aaaaaa';ctx.fill();
    });
    // eyes (blink occasionally)
    const blink=Math.sin(f*.08)>0.9;
    const ey=cy+18*sc;
    [-12,12].forEach(ex=>{
      ctx.beginPath();
      if(blink){ctx.ellipse(cx+ex,ey,4*sc,1.5*sc,0,0,Math.PI*2)}
      else{ctx.arc(cx+ex,ey,4*sc,0,Math.PI*2)}
      ctx.fillStyle='#fff';ctx.fill();
      if(!blink){ctx.beginPath();ctx.arc(cx+ex+.5,ey,2*sc,0,Math.PI*2);ctx.fillStyle='#111';ctx.fill()}
    });
    f++;cv._aid=requestAnimationFrame(draw);
  }
  draw();
}

// ‚îÄ‚îÄ CONFETTI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function spawnConf(n=44){
  const cols=['#ff6b6b','#ffd166','#06d6a0','#118ab2','#a855f7','#f472b6','#ffffff'];
  const app=document.getElementById('app');
  for(let i=0;i<n;i++){
    const c=document.createElement('div');c.className='cfp';
    c.style.left=Math.random()*100+'%';
    c.style.background=cols[Math.floor(Math.random()*cols.length)];
    c.style.animationDuration=(Math.random()*2+1.3)+'s';
    c.style.animationDelay=(Math.random()*.85)+'s';
    const sz=(Math.random()*7+4)+'px';c.style.width=c.style.height=sz;
    if(Math.random()>.5)c.style.borderRadius='50%';
    app.appendChild(c);setTimeout(()=>c.remove(),3300);
  }
}

// ‚îÄ‚îÄ QUIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function confirmQuit(){
  G.locked=true;
  showOv('üö™',L.quitq,'',[
    {lbl:L.quity,style:'background:rgba(200,50,50,.2);border:1px solid rgba(200,50,50,.4);color:#ff8888;',
      fn:()=>{hideOv();clearInterval(G.tInt);if(G.peekTO){clearTimeout(G.peekTO);G.peekTO=null}showScreen('screen-mode')}},
    {lbl:L.quitn,style:'background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.13);color:#fff;',
      fn:()=>{hideOv();G.locked=false}},
  ]);
}

// ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _tTO;
function toast(msg){
  const el=document.getElementById('toast');
  el.textContent=msg;el.classList.add('show');
  clearTimeout(_tTO);_tTO=setTimeout(()=>el.classList.remove('show'),2100);
}

// ‚îÄ‚îÄ BOOT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
initSplash();
document.getElementById('screen-splash').addEventListener('click',()=>showScreen('screen-lang'));
</script>
</body>
</html>
