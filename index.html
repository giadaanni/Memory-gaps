<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Memory Gaps</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;600&family=Orbitron:wght@700;900&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{--w:min(100vw,430px);--h:100dvh;--cr:8px;--flip:.42s;
  --fd:'Bebas Neue',sans-serif;--fu:'DM Sans',sans-serif;--fh:'Orbitron',monospace}
html,body{width:100%;height:100%;overflow:hidden;background:#000;
  display:flex;justify-content:center;align-items:center;
  font-family:var(--fu);-webkit-tap-highlight-color:transparent;
  touch-action:manipulation;user-select:none}
#app{width:var(--w);height:var(--h);position:relative;overflow:hidden;background:#0a0a0a}
.screen{position:absolute;inset:0;display:flex;flex-direction:column;
  align-items:center;justify-content:center;
  opacity:0;pointer-events:none;transition:opacity .4s ease;overflow:hidden}
.screen.active{opacity:1;pointer-events:all}

/* â”€â”€ SPLASH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#ss{background:#000;cursor:default}
#ss-bg{position:absolute;inset:0;background:radial-gradient(ellipse at 50% 36%,#1a0a2e,#000 70%)}
#sparks{position:absolute;inset:0;overflow:hidden}
.spark{position:absolute;border-radius:50%;animation:sfloat linear infinite;opacity:0}
@keyframes sfloat{0%{transform:translateY(110vh) scale(0);opacity:0}10%{opacity:.9}90%{opacity:.3}100%{transform:translateY(-30px) scale(1.8);opacity:0}}

/* Splash logo SVG: sits between bg (z0) and content (z3) */
#splash-svg-wrap{
  position:absolute;
  top:50%;left:50%;
  transform:translate(-50%,-50%);
  width:min(85vw,340px);
  z-index:1;
  pointer-events:none;
  opacity:0;
  animation:slogo-in 1.2s .4s cubic-bezier(.22,1,.36,1) forwards;
}
#splash-svg-wrap svg{width:100%;height:auto;display:block}
@keyframes slogo-in{
  0%  {opacity:0;transform:translate(-50%,-50%) scale(.88)}
  60% {opacity:.22;transform:translate(-50%,-50%) scale(1.02)}
  100%{opacity:.18;transform:translate(-50%,-50%) scale(1)}
}

/* All foreground items stacked in a flex column, no overlap */
.splash-content{
  position:relative;z-index:3;
  display:flex;flex-direction:column;align-items:center;
  gap:0;
  width:100%;padding:0 20px;
  /* push content slightly toward center-upper area */
  margin-top:-20px;
}
.s-logo{text-align:center;margin-bottom:22px;pointer-events:none}
.s-t{font-family:var(--fd);font-size:clamp(52px,14vw,72px);letter-spacing:6px;color:#fff;
  line-height:.88;text-shadow:0 0 40px rgba(160,100,255,.5),0 0 90px rgba(100,60,200,.3);
  animation:sup .7s .1s ease both}
.s-sub{font-family:var(--fu);font-size:10px;letter-spacing:7px;
  color:rgba(255,255,255,.3);text-transform:uppercase;margin-top:10px;
  animation:sup .7s .3s ease both}
@keyframes sup{from{transform:translateY(14px);opacity:0}to{transform:translateY(0);opacity:1}}

/* splash 3D cards */
.splash-cards{display:flex;gap:24px;margin-bottom:28px;
  animation:sup .7s .5s ease both}
.s-card{width:66px;height:90px;perspective:600px;cursor:grab;flex-shrink:0}
.s-card-inner{width:100%;height:100%;position:relative;transform-style:preserve-3d;
  transition:transform .6s cubic-bezier(.4,0,.2,1);border-radius:10px}
.s-card.flipped .s-card-inner{transform:rotateY(180deg)}
.s-face{position:absolute;inset:0;backface-visibility:hidden;-webkit-backface-visibility:hidden;
  border-radius:10px;display:flex;align-items:center;justify-content:center;overflow:hidden}
.s-back{background:linear-gradient(135deg,#1a0a3a,#0d0520);
  border:1px solid rgba(255,255,255,.14)}
.s-back::before{content:'';position:absolute;inset:1px;border-radius:9px;
  background:repeating-linear-gradient(45deg,transparent,transparent 4px,
    rgba(255,255,255,.025) 4px,rgba(255,255,255,.025) 5px)}
/* inline SVG on card back: sized and colored via CSS */
.s-back .card-svg-logo{width:52%;height:52%;color:rgba(160,100,255,.85);flex-shrink:0}
.s-back .card-svg-logo svg{width:100%;height:100%;display:block}
.s-front{transform:rotateY(180deg);font-size:34px;
  background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1)}
.tap{position:relative;z-index:2;font-family:var(--fh);font-size:11px;letter-spacing:5px;
  color:rgba(255,255,255,.5);text-transform:uppercase;animation:blink 1.5s 1s ease-in-out infinite,sup .7s .7s ease both;
  margin-top:4px}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.08}}

/* inline SVG on card back: sized and colored via CSS */
.card-svg-logo{width:52%;height:52%;color:rgba(160,100,255,.85);flex-shrink:0}
.card-svg-logo svg{width:100%;height:100%;display:block}

/* â”€â”€ TILED BG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.tbg{position:absolute;inset:0;display:grid;gap:4px;padding:4px;
  filter:blur(1.5px);opacity:.26;pointer-events:none}
.tbc{background:linear-gradient(135deg,#1a1040,#0d1a3a);border:1px solid rgba(255,255,255,.05);
  border-radius:5px;display:flex;align-items:center;justify-content:center;font-size:15px}
.tov{position:absolute;inset:0;
  background:linear-gradient(180deg,rgba(6,6,16,.8) 0%,rgba(6,6,16,.52) 50%,rgba(6,6,16,.9) 100%);
  pointer-events:none}

/* â”€â”€ MENUS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.mwrap{position:relative;z-index:2;display:flex;flex-direction:column;
  align-items:center;gap:13px;padding:32px 24px;width:100%}
.mttl{font-family:var(--fd);font-size:clamp(32px,9vw,46px);letter-spacing:4px;color:#fff;
  text-align:center;line-height:.95}
.msub{font-size:10px;letter-spacing:3px;color:rgba(255,255,255,.36);
  text-transform:uppercase;margin-top:-5px}
.mbtn{width:100%;max-width:272px;padding:15px 16px;border:none;border-radius:12px;
  font-family:var(--fu);font-size:14px;font-weight:600;letter-spacing:.4px;
  cursor:pointer;position:relative;overflow:hidden;transition:transform .15s ease}
.mbtn::after{content:'';position:absolute;inset:0;background:rgba(255,255,255,.12);
  opacity:0;transition:opacity .15s}
.mbtn:active{transform:scale(.96)}.mbtn:active::after{opacity:1}
.bl{background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.12);color:#fff;
  display:flex;align-items:center;gap:12px;justify-content:center}
.bl .flag{font-size:22px}
.bp{background:linear-gradient(135deg,#5a28e0,#2e7de8);color:#fff;
  box-shadow:0 8px 24px rgba(90,40,224,.4)}
.br{background:linear-gradient(135deg,#d42f5a,#e86c2e);color:#fff;
  box-shadow:0 8px 24px rgba(212,47,90,.3)}
.bg{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);
  color:#fff;font-size:12px}
.mopt{width:100%;max-width:272px;padding:13px 15px;border:1px solid rgba(255,255,255,.11);
  border-radius:11px;background:rgba(255,255,255,.05);color:#fff;font-family:var(--fu);
  font-size:14px;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:9px;transition:background .15s}
.mopt:active{background:rgba(255,255,255,.13)}
.mico{font-size:19px;flex-shrink:0}

/* â”€â”€ GAME SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#sg{flex-direction:column;justify-content:flex-start;overflow:hidden}
/* themed canvas bg */
#theme-canvas{position:absolute;inset:0;z-index:0;pointer-events:none}
#theme-canvas.interactive{pointer-events:auto}
.game-ui{position:relative;z-index:1;width:100%;flex-shrink:0}

.ghdr{width:100%;padding:8px 11px 5px;display:flex;align-items:center;gap:7px;
  border-bottom:1px solid rgba(255,255,255,.07);background:rgba(0,0,0,.35);backdrop-filter:blur(4px)}
.hback{width:28px;height:28px;border:1px solid rgba(255,255,255,.16);border-radius:7px;
  background:rgba(255,255,255,.05);color:#fff;font-size:12px;
  display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0}
.hlv{font-family:var(--fd);font-size:16px;letter-spacing:2px;color:#fff;flex:1;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.htim{font-family:var(--fh);font-size:12px;color:#fff;
  background:rgba(0,0,0,.4);border:1px solid rgba(255,255,255,.12);
  border-radius:6px;padding:2px 7px;flex-shrink:0;transition:color .3s,border-color .3s}
.htim.warn{color:#ffaa44;border-color:rgba(255,170,68,.4)}
.htim.danger{color:#ff4444;border-color:rgba(255,68,68,.5);animation:tpulse .5s ease-in-out infinite}
@keyframes tpulse{0%,100%{opacity:1}50%{opacity:.4}}

.cdbar{width:100%;height:3px;background:rgba(255,255,255,.07)}
.cdfill{height:100%;width:100%;background:linear-gradient(90deg,#06d6a0 0%,#ffd166 50%,#ff4444 100%);
  background-size:200% 100%;background-position:0% 50%;transform-origin:left;transition:width 1s linear}

/* turn banner */
.tban{width:100%;padding:4px 11px;display:flex;align-items:center;gap:6px;
  background:rgba(0,0,0,.25);backdrop-filter:blur(3px)}
.tdot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.tlbl{font-family:var(--fd);font-size:14px;letter-spacing:2px}
.tsc{font-family:var(--fh);font-size:11px;margin-left:auto;color:rgba(255,255,255,.45)}

/* stats */
.stats{width:100%;padding:4px 11px 3px;display:flex;gap:6px}
.spill{flex:1;background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.08);
  border-radius:7px;padding:4px 6px;text-align:center;backdrop-filter:blur(3px)}
.slbl{font-size:6px;letter-spacing:2px;color:rgba(255,255,255,.35);
  text-transform:uppercase;display:block;margin-bottom:1px}
.sval{font-family:var(--fh);font-size:12px;color:#fff;display:block}

/* event bars â€” SP: one shared; MP: two player bars */
.ebars{width:100%;padding:3px 11px 3px;display:flex;gap:7px}
.ebar{flex:1}.elbl{font-size:6px;letter-spacing:2px;text-transform:uppercase;margin-bottom:2px;display:block}
.elbl.m{color:#ff7070}.elbl.b{color:#70ffaa}.elbl.b1{color:#4488ff}.elbl.b2{color:#ff4466}
.etrack{height:4px;background:rgba(255,255,255,.08);border-radius:3px;overflow:hidden}
.efill{height:100%;border-radius:3px;transition:width .35s cubic-bezier(.34,1.56,.64,1);width:0%}
.efill.m{background:linear-gradient(90deg,#ff4444,#ff9944)}
.efill.b{background:linear-gradient(90deg,#44ff88,#44ddff)}
.efill.b1{background:linear-gradient(90deg,#3366ff,#66aaff)}
.efill.b2{background:linear-gradient(90deg,#ff3366,#ff8866)}
.edots{display:flex;gap:2px;margin-top:2px;flex-wrap:wrap}
.edot{width:5px;height:5px;border-radius:50%;background:rgba(255,255,255,.1);
  border:1px solid rgba(255,255,255,.12);transition:all .22s ease}
.edot.mf{background:#ff6644;border-color:#ff6644;box-shadow:0 0 4px #ff6644}
.edot.bf{background:#44ff88;border-color:#44ff88;box-shadow:0 0 4px #44ff88}
.edot.b1f{background:#4488ff;border-color:#4488ff;box-shadow:0 0 4px #4488ff}
.edot.b2f{background:#ff4466;border-color:#ff4466;box-shadow:0 0 4px #ff4466}

/* â”€â”€ GRID â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#card-grid{flex:1;display:grid;padding:3px 8px 8px;gap:4px;
  width:100%;align-content:center;min-height:0;position:relative;z-index:1;
  pointer-events:auto}

/* â”€â”€ CARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.card{aspect-ratio:1;perspective:650px;cursor:pointer;position:relative}
.ci{width:100%;height:100%;position:relative;transform-style:preserve-3d;
  border-radius:var(--cr);transition:transform var(--flip) cubic-bezier(.4,0,.2,1)}
.card.flipped .ci,.card.matched .ci{transform:rotateY(180deg)}
.cface{position:absolute;inset:0;backface-visibility:hidden;-webkit-backface-visibility:hidden;
  border-radius:var(--cr);display:flex;align-items:center;justify-content:center;overflow:hidden}
.cback{z-index:2;border:1px solid rgba(255,255,255,.09)}
.cback::before{content:'';position:absolute;inset:1px;border-radius:calc(var(--cr) - 1px);
  background:repeating-linear-gradient(45deg,transparent,transparent 4px,
    rgba(255,255,255,.022) 4px,rgba(255,255,255,.022) 5px)}
/* inline SVG wrapper on card back â€” color driven by JS via 'color' property â†’ currentColor in SVG */
.cback-svg{width:52%;height:52%;position:relative;z-index:1;
  display:flex;align-items:center;justify-content:center;opacity:.85}
.cback-svg svg{width:100%;height:100%;display:block}
.cfront{transform:rotateY(180deg);font-size:clamp(11px,3.5vw,22px);
  border:1px solid rgba(255,255,255,.09);background:rgba(255,255,255,.04)}
.card.peek .ci{transform:rotateY(180deg) scale(1.25);box-shadow:0 10px 28px rgba(0,0,0,.65)}
.card.matched .ci{animation:mpop .44s cubic-bezier(.34,1.56,.64,1) forwards}
@keyframes mpop{0%{transform:rotateY(180deg) scale(1)}40%{transform:rotateY(180deg) scale(1.12)}
  65%{transform:rotateY(180deg) scale(.97)}100%{transform:rotateY(180deg) scale(1)}}
.card.removing{animation:crem .35s ease forwards}
@keyframes crem{0%{transform:scale(1);opacity:1}100%{transform:scale(0);opacity:0}}
.card.wrong .ci{animation:shake .36s ease forwards}
@keyframes shake{0%,100%{transform:rotateY(0) translateX(0)}
  22%{transform:rotateY(0) translateX(-5px)}45%{transform:rotateY(0) translateX(5px)}
  67%{transform:rotateY(0) translateX(-4px)}88%{transform:rotateY(0) translateX(4px)}}
.card.shuffling{animation:cshuffle .42s ease forwards}
@keyframes cshuffle{0%{transform:translateY(0) rotate(0)}35%{transform:translateY(-6px) rotate(-4deg)}
  65%{transform:translateY(-3px) rotate(3deg)}100%{transform:translateY(0) rotate(0)}}
.hint-ring{position:absolute;inset:-3px;border-radius:calc(var(--cr)+3px);
  border:2px solid #44ff88;animation:hpulse .9s ease-in-out infinite;pointer-events:none;z-index:10}
@keyframes hpulse{0%,100%{box-shadow:0 0 0 0 rgba(68,255,136,.5)}50%{box-shadow:0 0 0 5px rgba(68,255,136,0)}}
@keyframes bflip{0%{transform:perspective(900px) rotateY(0)}
  50%{transform:perspective(900px) rotateY(90deg) scaleX(.87)}100%{transform:perspective(900px) rotateY(0)}}
#card-grid.flipping{animation:bflip .7s ease forwards}

/* â”€â”€ OVERLAYS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.ov{position:absolute;inset:0;z-index:200;display:flex;align-items:center;justify-content:center;
  background:rgba(0,0,0,.82);opacity:0;pointer-events:none;
  transition:opacity .3s ease;backdrop-filter:blur(5px)}
.ov.show{opacity:1;pointer-events:all}
.ovp{text-align:center;padding:24px 20px;max-width:285px;width:100%}
.oico{font-size:50px;margin-bottom:7px}
.ottl{font-family:var(--fd);font-size:34px;letter-spacing:3px;color:#fff;margin-bottom:4px}
.odsc{font-size:12px;color:rgba(255,255,255,.48);line-height:1.5;margin-bottom:16px}
.orow{display:flex;gap:7px;justify-content:center;flex-wrap:wrap}
.obtn{padding:11px 22px;border:none;border-radius:10px;font-family:var(--fu);
  font-size:13px;font-weight:600;cursor:pointer;transition:transform .15s}
.obtn:active{transform:scale(.96)}
.bgrid{display:flex;flex-direction:column;gap:7px;width:100%;margin-top:4px}
.bopt{padding:10px 12px;border:1px solid rgba(255,255,255,.12);border-radius:9px;
  background:rgba(255,255,255,.06);color:#fff;font-family:var(--fu);
  cursor:pointer;display:flex;align-items:center;gap:8px;text-align:left;transition:background .15s}
.bopt:active{background:rgba(255,255,255,.13)}
.bico{font-size:19px;flex-shrink:0}
.bttl{display:block;font-size:12px;font-weight:700}
.bdsc{display:block;font-size:10px;color:rgba(255,255,255,.4);margin-top:1px}

/* level complete */
.cov{position:absolute;inset:0;z-index:400;background:rgba(0,0,0,.88);
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  opacity:0;pointer-events:none;transition:opacity .5s ease;backdrop-filter:blur(7px)}
.cov.show{opacity:1;pointer-events:all}
.cstars{font-size:40px;margin-bottom:5px;animation:spop .5s .3s cubic-bezier(.34,1.56,.64,1) both}
@keyframes spop{from{transform:scale(0);opacity:0}to{transform:scale(1);opacity:1}}
.cttl{font-family:var(--fd);font-size:48px;letter-spacing:4px;color:#fff;animation:sup .44s .4s ease both}
.csc{font-family:var(--fh);font-size:11px;color:rgba(255,255,255,.48);letter-spacing:2px;
  margin:5px 0 24px;animation:sup .44s .5s ease both}
@keyframes sup{from{transform:translateY(14px);opacity:0}to{transform:translateY(0);opacity:1}}
.cbtns{display:flex;gap:8px;animation:sup .44s .6s ease both}
.cbtn{padding:11px 16px;border:none;border-radius:10px;font-family:var(--fu);
  font-size:13px;font-weight:600;cursor:pointer;transition:transform .15s}
.cbtn:active{transform:scale(.96)}
.cbp{background:linear-gradient(135deg,#5a28e0,#2e7de8);color:#fff}
.cbs{background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.12);color:#fff}

/* game over */
.gov{position:absolute;inset:0;z-index:500;background:rgba(0,0,0,.92);
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  opacity:0;pointer-events:none;transition:opacity .5s ease;backdrop-filter:blur(8px)}
.gov.show{opacity:1;pointer-events:all}
.goico{font-size:66px;animation:goica .6s .2s cubic-bezier(.34,1.56,.64,1) both}
@keyframes goica{from{transform:scale(0) rotate(-15deg);opacity:0}to{transform:scale(1) rotate(0);opacity:1}}
.gottl{font-family:var(--fd);font-size:54px;letter-spacing:4px;color:#ff4444;
  text-shadow:0 0 26px rgba(255,68,68,.5);animation:sup .44s .4s ease both}
.gosub{font-size:11px;color:rgba(255,255,255,.4);letter-spacing:2px;margin:4px 0 24px;animation:sup .44s .5s ease both}
.gobtns{display:flex;flex-direction:column;gap:8px;width:100%;max-width:200px;animation:sup .44s .6s ease both}
.gobtn{padding:12px;border:none;border-radius:10px;font-family:var(--fu);font-size:14px;
  font-weight:600;cursor:pointer;width:100%;transition:transform .15s}
.gobtn:active{transform:scale(.96)}
.retry{background:linear-gradient(135deg,#ffd166,#ff9f1c);color:#000}
.gmnu{background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.12);color:#fff}

/* winner */
.wov{position:absolute;inset:0;z-index:600;display:flex;flex-direction:column;
  align-items:center;justify-content:center;
  opacity:0;pointer-events:none;transition:opacity .4s ease}
.wov.show{opacity:1;pointer-events:all}
canvas#bc{display:block;margin:0 auto 4px}
.wttl{font-family:var(--fd);font-size:clamp(36px,10vw,52px);letter-spacing:4px;text-align:center;
  animation:wpop .55s .2s cubic-bezier(.34,1.56,.64,1) both}
@keyframes wpop{from{transform:scale(.6);opacity:0}to{transform:scale(1);opacity:1}}
.wp1{color:#4488ff;text-shadow:0 0 26px rgba(68,136,255,.6)}
.wp2{color:#ff4466;text-shadow:0 0 26px rgba(255,68,102,.6)}
.wsc{font-family:var(--fh);font-size:11px;color:rgba(255,255,255,.44);letter-spacing:2px;
  margin:6px 0 20px;text-align:center;animation:sup .4s .45s ease both}
.wrow{display:flex;gap:8px;animation:sup .4s .55s ease both}
.wbp{background:linear-gradient(135deg,#5a28e0,#2e7de8);color:#fff;padding:11px 16px;
  border:none;border-radius:10px;font-family:var(--fu);font-size:13px;font-weight:600;cursor:pointer}
.wbs{background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.12);color:#fff;
  padding:11px 16px;border-radius:10px;font-family:var(--fu);font-size:13px;font-weight:600;cursor:pointer}

/* confetti */
.cfp{position:absolute;border-radius:2px;animation:cfall linear forwards;pointer-events:none;z-index:650}
@keyframes cfall{0%{transform:translateY(-20px) rotate(0);opacity:1}100%{transform:translateY(110vh) rotate(720deg);opacity:0}}

/* toast */
.toast{position:absolute;bottom:60px;left:50%;
  transform:translateX(-50%) translateY(12px);
  background:rgba(14,14,28,.95);border:1px solid rgba(255,255,255,.12);
  border-radius:9px;padding:7px 14px;font-size:11px;color:#fff;font-weight:600;
  white-space:nowrap;opacity:0;transition:all .3s cubic-bezier(.34,1.56,.64,1);
  pointer-events:none;z-index:300;backdrop-filter:blur(8px)}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

/* peek bar */
.pkbar{position:absolute;bottom:0;left:0;right:0;height:3px;background:rgba(255,255,255,.08);z-index:500;display:none}
.pkfill{height:100%;background:linear-gradient(90deg,#44ff88,#44ddff);width:100%}

/* arcade level list */
.lvrow{display:flex;align-items:center;gap:8px;padding:8px 11px;border-radius:8px;
  border:1px solid rgba(255,255,255,.09);background:rgba(255,255,255,.05);
  width:100%;max-width:272px}
.lvrow.lkd{opacity:.35;border-color:rgba(255,255,255,.04)}
</style>
</head>
<body>
<div id="app">

<!-- SPLASH -->
<div id="ss" class="screen active">
  <!-- Layer 1: radial gradient bg -->
  <div id="ss-bg"></div>
  <!-- Layer 2: floating sparks -->
  <div id="sparks"></div>
  <!-- Layer 3: splash logo SVG (between bg and text) -->
  <div id="splash-svg-wrap"></div>

  <!-- Layer 4: all foreground content stacked vertically, no overlap -->
  <div class="splash-content">
    <!-- game title -->
    <div class="s-logo">
      <div class="s-t">MEMORY<br>GAPS</div>
      <div class="s-sub">Card Matching Game</div>
    </div>
    <!-- 3D swipe cards -->
    <div class="splash-cards" id="splash-cards">
      <div class="s-card" id="sc0">
        <div class="s-card-inner">
          <div class="s-face s-back" id="sc0back"></div>
          <div class="s-face s-front">ğŸ¹</div>
        </div>
      </div>
      <div class="s-card" id="sc1">
        <div class="s-card-inner">
          <div class="s-face s-back" id="sc1back"></div>
          <div class="s-face s-front">ğŸ¸</div>
        </div>
      </div>
    </div>
    <!-- tap prompt -->
    <div class="tap" id="stap">TAP ANYWHERE TO START</div>
  </div>
</div>

<!-- LANGUAGE -->
<div id="sl" class="screen">
  <div class="tbg" id="tbgl"></div><div class="tov"></div>
  <div class="mwrap">
    <div class="mttl">MEMORY<br>GAPS</div>
    <div class="msub" id="lcl">Choose language</div>
    <button class="mbtn bl" onclick="setLang('en')"><span class="flag">ğŸ‡¬ğŸ‡§</span> English</button>
    <button class="mbtn bl" onclick="setLang('it')"><span class="flag">ğŸ‡®ğŸ‡¹</span> Italiano</button>
  </div>
</div>

<!-- MODE -->
<div id="sm" class="screen">
  <div class="tbg" id="tbgm"></div><div class="tov"></div>
  <div class="mwrap">
    <div class="mttl" id="mttl">CHOOSE MODE</div>
    <div class="msub" id="msub">Select your game type</div>
    <button class="mbtn bp" onclick="showArc()" id="bsp">âš¡ SINGLE PLAYER</button>
    <button class="mbtn br" onclick="showMulti()" id="bmp">ğŸ†š MULTIPLAYER</button>
  </div>
</div>

<!-- ARCADE -->
<div id="sa" class="screen">
  <div class="tbg" id="tbga"></div><div class="tov"></div>
  <div class="mwrap">
    <div class="mttl" style="color:#ffd166">âš¡ ARCADE</div>
    <div class="msub" id="atag">BEAT THE CLOCK</div>
    <div id="arclist" style="display:flex;flex-direction:column;gap:6px;width:100%;max-width:272px;margin-bottom:10px"></div>
    <button class="mbtn bp" onclick="startArcade()" id="barc" style="max-width:210px">â–¶ START</button>
    <button class="mbtn bg" onclick="showScreen('sm')" id="baback" style="max-width:210px">â† BACK</button>
  </div>
</div>

<!-- MULTI SELECT -->
<div id="smu" class="screen">
  <div class="tbg" id="tbgmu"></div><div class="tov"></div>
  <div class="mwrap">
    <div class="mttl" id="muttl">MATCH TYPE</div>
    <div class="msub" id="musub">How many rounds?</div>
    <button class="mopt" onclick="startMultiGame(1)"><span class="mico">âš¡</span><span id="mo1">Single Match</span></button>
    <button class="mopt" onclick="startMultiGame(3)"><span class="mico">ğŸ¥Š</span><span id="mo3">Best of 3</span></button>
    <button class="mopt" onclick="startMultiGame(5)"><span class="mico">ğŸ†</span><span id="mo5">5 Rounds</span></button>
    <button class="mbtn bg" onclick="showScreen('sm')" id="muback" style="max-width:272px;margin-top:4px">â† BACK</button>
  </div>
</div>

<!-- GAME -->
<div id="sg" class="screen">
  <canvas id="theme-canvas"></canvas>

  <div class="game-ui">
    <div class="ghdr">
      <div class="hback" onclick="confirmQuit()">â†</div>
      <div class="hlv" id="hlv">OCEAN</div>
      <div class="htim" id="htim">0:00</div>
    </div>
    <div class="cdbar"><div class="cdfill" id="cdf"></div></div>

    <div class="tban" id="tban" style="display:none">
      <div class="tdot" id="tdot"></div>
      <div class="tlbl" id="tlbl">PLAYER 1</div>
      <div class="tsc" id="tsc">0 â€” 0</div>
    </div>

    <div class="stats">
      <div class="spill"><span class="slbl" id="lpa">PAIRS</span><span class="sval" id="spa">0/0</span></div>
      <div class="spill"><span class="slbl" id="lsc">SCORE</span><span class="sval" id="ssc">0</span></div>
      <div class="spill"><span class="slbl" id="ler">ERRORS</span><span class="sval" id="ser">0</span></div>
    </div>

    <div class="ebars" id="ebars">
      <!-- filled by JS -->
    </div>
  </div>

  <div id="card-grid"></div>

  <div class="ov" id="evov">
    <div class="ovp">
      <div class="oico" id="evico"></div>
      <div class="ottl" id="evttl"></div>
      <div class="odsc" id="evdsc"></div>
      <div id="evbtns"></div>
    </div>
  </div>

  <div class="cov" id="cov">
    <div class="cstars" id="cst">â­â­â­</div>
    <div class="cttl" id="cttl">CLEARED!</div>
    <div class="csc" id="csc"></div>
    <div class="cbtns">
      <button class="cbtn cbp" id="bnxt">NEXT â–¶</button>
      <button class="cbtn cbs" id="bcmnu">MENU</button>
    </div>
  </div>

  <div class="gov" id="gov">
    <div class="goico">ğŸ’€</div>
    <div class="gottl" id="gottl">YOU LOSE</div>
    <div class="gosub" id="gosub">TIME'S UP!</div>
    <div class="gobtns">
      <button class="gobtn retry" id="brtry">ğŸ”„ TRY AGAIN</button>
      <button class="gobtn gmnu" id="bgomnu">â† MENU</button>
    </div>
  </div>

  <div class="wov" id="wov">
    <canvas id="bc" width="180" height="162"></canvas>
    <div class="wttl" id="wttl">P1 WON!</div>
    <div class="wsc" id="wsc"></div>
    <div class="wrow" id="wrow"></div>
  </div>

  <div class="pkbar" id="pkbar"><div class="pkfill" id="pkf"></div></div>
  <div class="toast" id="toast"></div>
</div>

</div><!-- #app -->
<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MEMORY GAPS  v3.0
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* â”€â”€ INLINE SVG ASSETS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Using inline SVG solves CORS completely â€” CSS filters work,
   no external requests needed, works offline too.
   To swap in your real SVGs: replace the strings below.
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

// BACK CARD LOGO â€” real SVG inline, CSS classes replaced with fill attributes
// Original: Back_card.svg (viewBox 0 0 14400 14400, white paths = diamond/arrow shape)
// Converted: all .st0{fill:#fff} replaced with fill="currentColor" so it tints per level
const SVG_BACK = `<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 14400 14400">
  <defs>
    <clipPath id="bcp1">
      <path d="M7187.94,7689.41c.95-.29,1.68-1.12,1.68-2.37v-974.02c.02-2.7-2.7-4.42-5.05-3.22l-472.92,242.59c-1.91.98-2.55,3.47-1.38,5.28l474.91,730.75c.67,1.03,1.8,1.29,2.76,1ZM7211.06,7689.49c.96.3,2.1-.03,2.76-1.07l474.91-730.75c1.18-1.81.53-4.3-1.38-5.28l-472.92-242.59c-2.35-1.2-5.13.52-5.13,3.22v974.02c0,1.25.81,2.15,1.76,2.45Z"/>
    </clipPath>
    <clipPath id="bcp2">
      <path d="M7187.94,7689.41c.95-.29,1.68-1.12,1.68-2.37v-974.02c.02-2.7-2.7-4.42-5.05-3.22l-472.92,242.59c-1.91.98-2.55,3.47-1.38,5.28l474.91,730.75c.67,1.03,1.8,1.29,2.76,1ZM7211.06,7689.49c.96.3,2.1-.03,2.76-1.07l474.91-730.75c1.18-1.81.53-4.3-1.38-5.28l-472.92-242.59c-2.35-1.2-5.13.52-5.13,3.22v974.02c0,1.25.81,2.15,1.76,2.45Z"/>
    </clipPath>
  </defs>
  <path fill="currentColor" d="M7187.94,7689.41c.95-.29,1.68-1.12,1.68-2.37v-974.02c.02-2.7-2.7-4.42-5.05-3.22l-472.92,242.59c-1.91.98-2.55,3.47-1.38,5.28l474.91,730.75c.67,1.03,1.8,1.29,2.76,1ZM7211.06,7689.49c.96.3,2.1-.03,2.76-1.07l474.91-730.75c1.18-1.81.53-4.3-1.38-5.28l-472.92-242.59c-2.35-1.2-5.13.52-5.13,3.22v974.02c0,1.25.81,2.15,1.76,2.45Z"/>
  <g clip-path="url(#bcp1)">
    <g>
      <path fill="currentColor" d="M7187.94,7689.41c.95-.29,1.68-1.12,1.68-2.37v-974.02c.02-2.7-2.7-4.42-5.05-3.22l-472.92,242.59c-1.91.98-2.55,3.47-1.38,5.28l474.91,730.75c.67,1.03,1.8,1.29,2.76,1ZM7211.06,7689.49c.96.3,2.1-.03,2.76-1.07l474.91-730.75c1.18-1.81.53-4.3-1.38-5.28l-472.92-242.59c-2.35-1.2-5.13.52-5.13,3.22v974.02c0,1.25.81,2.15,1.76,2.45Z"/>
      <g clip-path="url(#bcp2)">
        <rect fill="currentColor" x="2102.7" y="5370.68" width="10034.33" height="7525.75"/>
      </g>
    </g>
  </g>
</svg>`;

// SPLASH LOGO â€” real SVG inline, CSS classes replaced with fill attributes
// Original: MemoryGaps copy.svg (viewBox 0 0 1024 1536, coloured game character/logo)
// Note: CSS class fills replaced with fill attributes directly on each path
const SVG_SPLASH_LOGO = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1024 1536">
  <path fill="#242d3b" d="M730,787c-2.97-.61-3.13,2.55,0,2-1.29,21.02-3.63,40.64-9.5,61-1.52,5.28-7.88,19.11-8.21,22.64-.24,2.62,2.37,9.27,2.69,12.88,4.64,51.53-36.61,78.05-83.98,74.48v16.5c0,12.72-15.97,29.09-27.32,33.68-4.71,1.9-11.06,1.73-13.68,5.81,39.23,6.27,89.41,26.9,111,62.01,2.22,3.61,5.53,10.46,7.02,14.48.82,2.2,4.11,10.77,2.03,12.07-25.23,3.91-50.65,6.23-76.05,8.45,3.65-4.77,8.94,1.65,9.01-6.98-7.34-2.67-10.07-.8-10.01,6.98-90.13,7.78-182.49,7.72-272.49-2.01-16.19-1.75-32.46-4.25-48.48-7.04-1.48-2.13,7.92-22.81,9.97-25.95,1.16-1.77,2.98-2.79,4-4,3.69,2.71,5.18-2.44,4.99-4.99-3.23-.79-1.36,1.92-2.16,2.81-.5.55-1.71.06-1.83.19,7.2-12.21,20.2-22,32.1-29.44,1-.63,2.53-.33,2.9-.56-.09,5.6,8.37-1.79,1-1,7.17-4.2,13.07-7.66,21-11,.84,3.12-3.52,2.42-4,3.01-2.69,3.31,4.73,1.09,5.92.41,12.04-6.94,19.45-6.07,32.35-8.64,2.53-.5,12.19-6.01,5.32-5.65-1.79.09-4.27-.15-4.59-.13l13.99-3.49c-2.33-3.26-6.57-2.71-9.95-4.05-22.83-9.01-31.69-26.21-31.04-50.46-20.77-.85-43.41-2.77-60.02-16.48-17.62-14.55-25.05-36.33-22.97-59,.33-3.57,3.1-10.41,2.79-12.78-.68-5.34-7.79-20.85-9.73-28.31-7.32-28.17-9.7-56.35-9.08-85.42l9.99,2c.11-3.5-.13-7.04,0-10.54.08-1.92-1.03-4.01,2-3.45-1.43,34.33,2,70.95,12.98,103.52,1.66,4.94,7.28,15.38,7.85,19.23.27,1.8-4.06,11.99-4.55,16.03-1.41,11.7,1.55,24.95,7.2,35.24,15.37,27.96,51.46,27.39,79.52,27.98v25.5c0,1.68,2.15,9.06,2.98,11.02,3.42,8.1,8.43,9.91,16.02,12.48,8.38,2.84,21.1,4.56,30,3-1.45,6.01,7.75,1.4,2-1,5.99-3.13,7.81-9.9,9-16,7.15,1.03,8.33-8.87,9-14,1.23.78,1.68.71,1.98,2.49,2.06,12.26-1.68,24.77,13.23,29.79,9.37,3.16,34.74,3.03,43.49-2.08,12.78-7.45,5.41-28.72,11.96-31.04,9.5-3.37,7.57,12.92,8.78,18.89,3.02,14.99,15.69,14,28.56,12.94.96,6.08,8.31,5.08,8-1,8.74-2.13,18.06-8.9,20.72-17.78.7-2.33,2.28-9.72,2.28-11.72v-21.5c26.17-.01,61.77-.83,78-25,1.14,4.13,11.67-.23,12.03-1.72.67-2.73-1.04-13.56-6.03-12.28.35-1.26,2-7.11,2-7.5v-20c0-2.48-4.06-9.36-3.92-12.02.07-1.31,5.57-14.52,6.62-17.24,12.87-33.32,16.74-78.85,13.29-115.73-.8-8.61-3.2-27.75-6.97-35.03-3.35-6.48-20.11-16.53-27.03-19.47,3.53-1.46,4.65-3.58,6-7,23.11,10.82,32.81,17.06,37.71,43.79,4.08,22.28,3.49,44.95,2.29,67.21ZM451.99,1003.01c-3.04.26-6.55-.38-9.51,0-1.39.18-2.88.53-1.48,1.99s6.77.88,8.83.3c1.76-.5,2.6.34,2.16-2.28ZM432.01,1019.99c1.79.19,7.62.52,6.99-2.48-.77-3.62-8.93.93-6.99,2.48ZM485,1067c-.85,3.74,2.29,4.68,2,1,1.39.41,4.85.56,7,1,3.07.63,6.99,1.72,10,2,.21,3.97,5.08,4.72,4,0,2.56.1,5.46.16,8,0,1.5,8.64,13.43,9.32,20.29,7.79,4.61-1.03,16.93-10.67,12.71-16.79,1.13-.61,3.48-1.66,4-2,6.19,4.4,9.75-2.97,12.7-3.8,2.13-.6,4.47.2,6.6-.4,5.67-1.58,9.34-18.5.7-18.8.37-.86,3.69-8.19.52-6.99-2.06.78-7.23,5.46-10.01,6.99-14.29,7.88-29.23,11.4-45.51,11.99-.56-3.18,1.6-1.76,3.49-1.97,4.01-.43,9.89-.5,13.55-1.52,1.29-.36,2.38-.27,1.96-2-.5-1.02-19.11-9.39-20.55-9.47-4.53-.27-21.59,3.03-25.82,5.09-1.53.75-5.06,2.95-5.62,4.39-1.03,2.67,4.09.07,2.99,3.49-4.3-.81-8.85-1.64-13-3-9.31-3.06-19.08-8.54-26.5-15-1.26,2.15.4,5.57,1.32,7.68,5.52,12.76,22.27,25.76,35.19,30.31ZM404.26,1049.27c-.61,5.03-5.78,6.63-4.08,12.04,1.42,4.51,28.06,15.44,29.82,5.14,1-5.87-3.81-6.29-5.88-10.07s-.01-6.35-6.06-7.94c-3.3-.87-11.48-2.07-13.8.83ZM607,1113.99c2.01-2.03-3.48-6.49-4.99-2.49-1.4,3.72,4.72,2.75,4.99,2.49Z"/>
  <path fill="#252f3d" d="M293,759c.31-14.63,1.62-49.97,10-61.5,13.72-18.86,45.65-27.63,66.58-35.45-4.58-23.28-24.83-54.07,6.9-67.07,18.96-7.77,46.33-14.89,66.52-20.48,17.92-4.96,36.12-12.04,47.54,8.46l19.44,63.37c6,3.19.57-5.38.11-8.91-.33-2.5-.19-5.28.04-7.8,2.48-27.1,14.83-58.72,18.83-86.17,6.31-13.84,16.67-17.54,31.08-14.99,22.24,3.93,58.05,11.84,79.19,18.81,12.22,4.03,20.91,14.87,19.76,28.21l-17.99,84.51c17.25,2.54,33.4,8.7,49,16-1.35,3.42-2.47,5.54-6,7-9.03-3.83-36.52-12.41-45.66-12.95-4.83-.28-4.42,2.6-7.38,4.4-2.3,1.4-5.66,1.52-6.95,3.53,18.69,3.47,39.64,8.21,56.69,16.82,35.57,17.97-6.55,30.74-24.48,35.91-40.05,11.54-82.26,13.93-123.71,15.29-54,1.78-124.68-.21-176.05-17.97-21.95-7.59-44.81-18.67-11.68-34.75,9.84-4.78,20.66-7.57,31.19-10.33-.34-2.64-1.47-9.76-4.46-9.99-3.26-.26-19.57,5.72-23.76,7.29-10.6,3.96-33.5,13.42-37.27,24.73-.72,2.15-.97,5.51-1.48,8.02-2.21,10.77-3.54,23-4,34-3.03-.56-1.92,1.53-2,3.45-.14,3.5.11,7.05,0,10.54l-9.99-2ZM541.34,541.34c-1.72,1.72-3.11,5.27-3.86,7.64-6.39,20.19-12.8,53.52-16.19,74.81-2.08,13.05-3.68,21.69,10.7,26.71,25.06,8.76,56.07,11.38,81.8,19.24,8.48.94,15.94-4.31,17.75-12.7,3.23-26.06,14.38-54.1,17.18-79.82,1.07-9.9-.6-16.3-10.5-19.95-26.43-3.82-58.11-17.71-84.02-20.02-4.36-.39-9.7.93-12.86,4.09ZM461.74,579.24c-25.66,4.08-56.44,20.14-82.72,25.28-11.06,5.03-11.47,13.33-8.95,23.9,5.43,22.79,14.86,54.07,22.91,76.09,3.49,9.54,8.37,14.33,19.25,14.29,27.09-9.76,57.62-15.44,84.31-25.77,10.6-4.1,12.71-11.07,10.81-21.88-4.73-26.9-19.48-57.12-25.83-84.17-3.92-7.89-11.68-9.04-19.77-7.75ZM569,671c4.22.36,8.73,2.11,13.01.5,0-.81-11.37-2.13-13.01-2.5-12.53-2.86-42.48-12.64-53.53-11-1.48.22-1.6-.59-1.49,1.51.1,1.96,1.99,8.8,3.66,9.36,3.54,1.2,16.87-.1,21.91.09,9.72.38,19.76,1.21,29.46,2.04Z"/>
  <path fill="#252e3c" d="M476.79,185.29c61.98-3.93,135.68,19.44,165.73,77.68,5.76,11.16,8.69,16.08-.01,27.03-27.35,34.45-135.82,69.3-179.51,81.49-38.37,10.7-111.18,28.83-149.23,21.23-19.37-3.87-20.65-18.76-21.76-36.24-6.3-99.27,95.57-165.54,184.78-171.2ZM360,243c-1.66,1.33-4.82,2.56-7.01,4.49-35.26,30.99-58.2,79.23-46.49,126.51,14.99-16.52,34.75-27.97,54.5-38,74.04-37.58,162.6-61,245.52-66.08l27.49,2.57c-34.9-68.1-120.27-86.17-190.22-70.2-32.24,7.36-58.32,20.34-83.79,40.71Z"/>
  <path fill="#e8e5e0" d="M322,1078c-2.05,3.14-11.46,23.82-9.97,25.95,16.03,2.78,32.3,5.29,48.48,7.04,90,9.73,182.36,9.79,272.49,2.01.33-.03.67.03,1,0,25.4-2.22,50.82-4.54,76.05-8.45,2.08-1.3-1.21-9.87-2.03-12.07-1.5-4.01-4.8-10.87-7.02-14.48,19.73,2.5,43,4.55,61.52,11.98,25.99,10.42-.09,19.28-13.3,22.75-45.53,11.97-102.55,13.25-149.77,15.23-81.67,3.42-167.38,3.5-248.95-3.96-20.87-1.91-78.78-7.76-94.84-18.16-13.83-8.96,4.67-15.56,12.58-18.1,16.9-5.44,36.17-7.36,53.76-9.74Z"/>
  <path fill="#27323f" d="M344.35,439.35c3.02-3.02,6.89-5.15,10.86-6.64,20.99-7.86,55.96-17.1,78.15-21.85,16.26-3.48,28.5-.82,36.11,15.15,5.98,26.18,15.22,51.62,21.23,77.77,3.89,16.94,1.44,30.43-16.19,37.24-20.38,7.87-58.01,17.93-79.68,22.32-15.93,3.23-27.18-1.34-34.32-16.36-4.43-26.64-19.68-57.78-23.26-83.74-1.31-9.49.28-17.08,7.09-23.89ZM440.74,419.24c-25.77,8.96-56.01,13.18-81.28,22.71-10.23,3.86-13.76,8.85-12.01,20.1,4.09,26.19,17.67,55.67,22.81,82.18,2.57,5.84,7.92,10.05,14.38,10.7,24.44-5.47,49.3-12.1,73.35-19.43,12.81-3.91,26.82-5.47,24.74-22.74-9.23-25.96-13.03-57.79-22.97-83.03-3.35-8.52-9.98-11.83-19.04-10.48Z"/>
  <path fill="#283241" d="M543.74,366.24c23.15-3.88,65.52,14,90.29,15.23,15.76,4.96,22.32,15.46,20.85,31.91-1.93,21.65-9.17,58.12-14.34,79.66-3.98,16.58-14.22,22.33-30.91,20.84-18.86-1.68-58.39-9.84-76.83-15.17-13.24-3.83-20.51-12.27-21.68-26.1,7.09-27.64,7.04-62.94,15.37-89.63,2.31-7.4,9.32-15.41,17.26-16.74ZM547.76,375.21c-7.32,1.05-10.33,5.28-12.11,11.94-7.14,26.78-8.31,58.13-14.67,85.4-.41,7.4,4.96,14.08,11.79,16.19,25.22,7.8,56.1,8.9,81.89,16.18,8.66-.15,13.79-4.63,16.05-12.72,7.34-26.26,8.29-58.14,15.03-84.98-.24-7.26-4.63-13.68-11.67-15.78-25.38-7.58-56.78-8.98-82.71-16.37-1.22-.28-2.38-.04-3.59.13Z"/>
  <path fill="#faf6f0" d="M684,683c6.92,2.94,23.68,12.99,27.03,19.47,3.77,7.29,6.16,26.43,6.97,35.03,3.45,36.89-.43,82.41-13.29,115.73-1.05,2.73-6.55,15.94-6.62,17.24-.14,2.66,3.92,9.54,3.92,12.02v20c0,.39-1.65,6.24-2,7.5-.47,1.69-1.36,4.39-2,6-.23.59-1.57,3.17-2,4-.58,1.1-1.55,3.33-2,4-16.23,24.17-51.83,24.99-78,25v21.5c0,2-1.58,9.39-2.28,11.72-2.66,8.88-11.98,15.65-20.72,17.78-1.31.32-6.29.86-8,1-12.87,1.06-25.54,2.05-28.56-12.94-1.2-5.97.72-22.26-8.78-18.89-6.54,2.32.82,23.59-11.96,31.04-8.75,5.1-34.12,5.23-43.49,2.08-14.91-5.02-11.17-17.53-13.23-29.79-.3-1.78-.75-1.71-1.98-2.49-9.78-6.22-8.09,9.36-9,14-1.19,6.1-3.01,12.87-9,16-.4.21-1.89.98-2,1-8.9,1.56-21.62-.16-30-3-10.61-15.87-8.42-33.87-7.01-51.99-12.23.33-23.46-11.84-31.02-20.48-35.9-41.08-45.06-111.22-43.01-164.07.14-3.7,3.22-25.2,2-26.42-9.8-2.32-22.65-7.46-30.43-14.07-3.05-2.59-4.93-6.62-8.52-7.98.52-2.51.77-5.87,1.48-8.02,3.77-11.3,26.67-20.77,37.27-24.73,4.19-1.56,20.5-7.54,23.76-7.29,2.99.23,4.13,7.36,4.46,9.99-10.53,2.76-21.34,5.55-31.19,10.33-33.14,16.08-10.27,27.16,11.68,34.75,51.36,17.76,122.04,19.76,176.05,17.97,41.45-1.37,83.66-3.75,123.71-15.29,17.93-5.17,60.05-17.94,24.48-35.91-17.05-8.61-38-13.34-56.69-16.82,1.29-2.02,4.66-2.14,6.95-3.53,2.96-1.8,2.55-4.69,7.38-4.4,9.14.54,36.64,9.11,45.66,12.95ZM420.78,789.28c-66.89,8.06-60.38,119.85,10.71,114.7,69.26-5.01,63.78-123.68-10.71-114.7ZM587.76,789.26c-64.84,8.19-57.19,118.24,11.74,114.73,72.61-3.7,63.25-124.2-11.74-114.73ZM510.73,874.19c-6.7.89-18.52,20.09-21.9,26.13-4.88,8.74-13.59,23.72-3.32,31.67,4.62,3.58,10.77,3.94,16.32,2.33,3.45-1,7.8-6.01,9.85-6.19,1.05-.09,7.52,5.62,11.27,6.42,12.09,2.58,21.41-3.15,20.05-16.07-.92-8.76-19.42-38.47-27.08-42.9-1.51-.88-3.4-1.63-5.19-1.4Z"/>
  <path fill="#e8e5e0" d="M309,713c3.59,1.36,5.47,5.39,8.52,7.98,7.78,6.6,20.64,11.74,30.43,14.07,1.23,1.21-1.85,22.71-2,26.42-2.05,52.85,7.11,122.98,43.01,164.07,7.55,8.64,18.79,20.81,31.02,20.48-1.41,18.12-3.6,36.12,7.01,51.99-7.59-2.57-12.6-4.38-16.02-12.48-.83-1.97-2.98-9.35-2.98-11.02v-25.5c-28.06-.59-64.15-.02-79.52-27.98-5.65-10.28-8.61-23.54-7.2-35.24.49-4.04,4.82-14.23,4.55-16.03-.57-3.85-6.18-14.29-7.85-19.23-10.98-32.57-14.41-69.19-12.98-103.52.46-11,1.79-23.23,4-34Z"/>
  <path fill="#f7f3ee" d="M518,1049c16.28-.59,31.22-4.12,45.51-11.99,2.78-1.53,7.95-6.22,10.01-6.99,3.17-1.2-.15,6.13-.52,6.99-2.88,6.72-13.93,19.03-20,23-.52.34-2.87,1.39-4,2-9.4,5.04-22.36,8.34-33,9-2.54.16-5.44.1-8,0-1.32-.05-2.69.12-4,0-3.01-.28-6.93-1.37-10-2l-5.02-12c-3.12-1.1-1.45,3.38-3.52,3.99-4.09,1.22-11.75-12.92-10.47-16.99,4.15,1.36,8.7,2.19,13,3,.61.12,1.37-.1,2,0,.11.02.26.77,2,1,8.53,1.13,17.39,1.31,26,1Z"/>
  <path fill="#fac902" d="M440.74,419.24c9.06-1.34,15.68,1.97,19.04,10.48,9.94,25.24,13.74,57.07,22.97,83.03,2.08,17.28-11.93,18.84-24.74,22.74-24.06,7.33-48.92,13.97-73.35,19.43-6.46-.64-11.81-4.85-14.38-10.7-5.14-26.51-18.72-55.99-22.81-82.18-1.76-11.25,1.78-16.24,12.01-20.1,25.26-9.54,55.5-13.76,81.28-22.71ZM429.72,459.19c-11.36,2.5-6.79,22,4.54,19.63s8.23-22.45-4.54-19.63ZM397.68,473.32c-9.2-10.05-23.64,7.47-11.64,15.15,10.94,7,18.7-7.43,11.64-15.15ZM390.3,509.71c7.46,9.36,25.5,11.06,36.23,7.32,8.3-2.89,23.46-16.89,20.33-26.38-2.17-6.59-6.82,2.63-7.86,3.85-10.64,12.45-24.76,16.6-40.55,11.54-3.3-1.06-4.99-4.67-9.37-1.94-.35,1.85.03,4.13,1.21,5.61Z"/>
  <path fill="#297eda" d="M547.76,375.21c1.2-.17,2.37-.41,3.59-.13,25.93,7.39,57.33,8.79,82.71,16.37,7.04,2.1,11.43,8.52,11.67,15.78-6.73,26.84-7.69,58.72-15.03,84.98-2.26,8.09-7.38,12.57-16.05,12.72-25.79-7.28-56.67-8.38-81.89-16.18-6.82-2.11-12.19-8.78-11.79-16.19,6.37-27.27,7.53-58.62,14.67-85.4,1.78-6.66,4.79-10.89,12.11-11.94ZM573.92,421.95c.31-.22,2.19-5.01,4.02-6.51,6.79-5.58,17.52-.81,15.87,7.81-1.77,9.21-19.24,9.67-21.57,23.49-1.78,10.61,5.72,6.52,13.19,9.14,2.52-3.12,1.93-6.69,5.07-9.88,6.82-6.94,19.24-6.47,22.06-19.94,4.45-21.3-19.2-33.77-37.77-27.78-4.43,1.43-15.25,10.91-15.66,15.41-.19,2.12,14.08,8.76,14.79,8.26ZM575.66,460.29c-13.16.66-11.9,21.36.82,20.78,13.53-.62,11.89-21.42-.82-20.78Z"/>
  <path fill="#287dd9" d="M541.34,541.34c3.16-3.16,8.5-4.48,12.86-4.09,25.91,2.31,57.59,16.21,84.02,20.02,9.9,3.65,11.57,10.05,10.5,19.95-2.79,25.72-13.95,53.76-17.18,79.82-1.8,8.39-9.27,13.64-17.75,12.7-25.74-7.86-56.74-10.48-81.8-19.24-14.38-5.03-12.78-13.67-10.7-26.71,3.39-21.29,9.8-54.63,16.19-74.81.75-2.36,2.14-5.91,3.86-7.64ZM621,601.01c-8.23-1.61-17.47-3.18-24.99-6.52-.38-1.65,15.41-17.55,17.43-20.55.71-1.05,2.16-2.67,1.13-3.98-4.01-.77-25.77-7.47-27.55-6.51l-33.88,41.22c-.18.58-.29,1.2-.12,1.8.54,1.9,18.74,5.29,21.99,5.54,2.69,2.8-17.32,29.76-16,30.99,1.87.44,2.77-.63,4.14-1.35,14.2-7.48,34.39-22.3,48.18-31.81,1.31-.91,11.21-7.35,9.67-8.82Z"/>
  <path fill="#ec372d" d="M461.74,579.24c8.09-1.29,15.85-.14,19.77,7.75,6.35,27.05,21.1,57.27,25.83,84.17,1.9,10.81-.21,17.78-10.81,21.88-26.68,10.32-57.21,16.01-84.31,25.77-10.88.04-15.76-4.74-19.25-14.29-8.05-22.02-17.48-53.3-22.91-76.09-2.52-10.58-2.12-18.87,8.95-23.9,26.27-5.14,57.06-21.2,82.72-25.28ZM431.99,625c-9.59-5-17.93-9.46-28.33-2.84-20.52,13.05-4.58,37.98,10.61,48.07,5.2,3.45,28.94,14.82,34.03,13.62,2.42-.58,10.61-11.81,12.51-14.53,9.12-13.03,17.81-29.83,12.49-46.12-6.97-21.32-37.7-20.66-41.31,1.8Z"/>
  <path fill="#f8c605" d="M621,601.01c1.54,1.47-8.36,7.91-9.67,8.82-13.79,9.52-33.99,24.34-48.18,31.81-1.37.72-2.27,1.8-4.14,1.35-1.33-1.23,18.69-28.19,16-30.99-3.25-.25-21.46-3.64-21.99-5.54-.17-.6-.05-1.22.12-1.8l33.88-41.22c1.78-.95,23.54,5.74,27.55,6.51,1.03,1.31-.42,2.93-1.13,3.98-2.02,3-17.81,18.91-17.43,20.55,7.52,3.34,16.76,4.91,24.99,6.52Z"/>
  <path fill="#fdf8f5" d="M431.99,625c3.61-22.46,34.34-23.13,41.31-1.8,5.32,16.29-3.37,33.09-12.49,46.12-1.91,2.72-10.09,13.95-12.51,14.53-5.08,1.21-28.83-10.16-34.03-13.62-15.2-10.08-31.13-35.01-10.61-48.07,10.4-6.62,18.74-2.16,28.33,2.84Z"/>
  <path fill="#faf6f0" d="M573.92,421.95c-.71.5-14.98-6.13-14.79-8.26.4-4.5,11.23-13.98,15.66-15.41,18.58-5.99,42.23,6.47,37.77,27.78-2.82,13.47-15.24,13-22.06,19.94-3.14,3.19-2.55,6.76-5.07,9.88-7.47-2.62-14.97,1.47-13.19-9.14,2.32-13.82,19.8-14.28,21.57-23.49,1.65-8.62-9.08-13.39-15.87-7.81-1.83,1.5-3.71,6.29-4.02,6.51Z"/>
  <path fill="#f7f3ee" d="M575.66,460.29c12.71-.64,14.35,20.16.82,20.78-12.73.58-13.98-20.12-.82-20.78Z"/>
</svg>`;

// â”€â”€ I18N â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const T={
  en:{
    cl:'Choose language',mode:'CHOOSE MODE',msub:'Select game type',
    sp:'âš¡ SINGLE PLAYER',mp:'ğŸ†š MULTIPLAYER',atag:'BEAT THE CLOCK',
    start:'â–¶ START',back:'â† BACK',
    pa:'PAIRS',sc:'SCORE',er:'ERRORS',ml:'MALUS',bn:'BONUS',
    b1:'P1 BONUS',b2:'P2 BONUS',
    cleared:'CLEARED!',next:'NEXT â–¶',
    slbl:(s,e,t)=>`SCORE ${s}  Â·  ${e} ERR  Â·  ${t}`,
    rot:'ROTATION!',rotd:'Board mirrors â€” cards scramble!',
    shuf:'SHUFFLE!',shufd:'Hidden cards rearranged!',
    rst:'RESET!',rstd:'Board resets. Clock keeps running!',
    bonus:'BONUS!',
    bpeek:'ğŸ‘ Peek All',bpeekd:'See all cards for 3s',
    bhint:'ğŸ’¡ Hint',bhintd:'A matching pair highlighted',
    bxtr:'ğŸ² Extra Try',bxtrd:'Two chances for the twin',
    ok:'OK',qq:'Quit to menu?',qy:'QUIT',qn:'KEEP PLAYING',
    ylose:'YOU LOSE',tup:"TIME'S UP!",retry:'ğŸ”„ TRY AGAIN',menu:'â† MENU',
    mtype:'MATCH TYPE',rounds:'How many rounds?',
    mo1:'Single Match',mo3:'Best of 3',mo5:'5 Rounds',
    p1:'PLAYER 1',p2:'PLAYER 2',pturn:"'S TURN",
    steal:'ğŸ¯ Steal',steald:"Steal opponent's next pair",
    skip:'â­ Skip',skipd:"Opponent skips next turn",
    dice:'ğŸ° Dice',diced:'Risk it to see all!',
    risk:'RISK IT?',riskd:'1 or 6 = see all for 3s!',
    accept:'ACCEPT',refuse:'REFUSE',
    rolling:'ğŸ² ROLLING...',dwin:'ğŸ° JACKPOT!',dlose:'ğŸ˜¬ Next time!',
    pwon:(n)=>`PLAYER ${n} WON!`,draw:'DRAW!',
    again:'PLAY AGAIN',bmenu:'â† MENU',ms:'MATCH',lv:'LEVEL',
  },
  it:{
    cl:'Scegli la lingua',mode:'SCEGLI MODO',msub:'Seleziona partita',
    sp:'âš¡ GIOCATORE SINGOLO',mp:'ğŸ†š MULTIGIOCATORE',atag:'BATTI IL TEMPO',
    start:'â–¶ INIZIA',back:'â† INDIETRO',
    pa:'COPPIE',sc:'PUNTI',er:'ERRORI',ml:'MALUS',bn:'BONUS',
    b1:'BONUS G1',b2:'BONUS G2',
    cleared:'COMPLETATO!',next:'AVANTI â–¶',
    slbl:(s,e,t)=>`PUNTI ${s}  Â·  ${e} ERR  Â·  ${t}`,
    rot:'ROTAZIONE!',rotd:'Il campo gira! Carte cambiano posizione!',
    shuf:'RIMESCOLATE!',shufd:'Carte coperte riposizionate!',
    rst:'RESET!',rstd:'Campo riparte. Il tempo continua!',
    bonus:'BONUS!',
    bpeek:'ğŸ‘ Svela',bpeekd:'Vedi tutte le carte per 3s',
    bhint:'ğŸ’¡ Indizio',bhintd:'Una coppia evidenziata',
    bxtr:'ğŸ² Extra',bxtrd:'Due tentativi per trovare la gemella',
    ok:'OK',qq:'Tornare al menu?',qy:'ESCI',qn:'CONTINUA',
    ylose:'HAI PERSO',tup:'TEMPO SCADUTO!',retry:'ğŸ”„ RIPROVA',menu:'â† MENU',
    mtype:'TIPO MATCH',rounds:'Quanti round?',
    mo1:'Match Singolo',mo3:'Al meglio dei 3',mo5:'5 Round',
    p1:'GIOCATORE 1',p2:'GIOCATORE 2',pturn:' â€” TURNO',
    steal:'ğŸ¯ Ruba',steald:"Ruba la coppia avversaria",
    skip:'â­ Salta',skipd:"L'avversario salta turno",
    dice:'ğŸ° Dado',diced:'Rischia per vedere tutto!',
    risk:'RISCHI?',riskd:'1 o 6 = vedi tutto 3s!',
    accept:'ACCETTA',refuse:'RIFIUTA',
    rolling:'ğŸ² IN ROLL...',dwin:'ğŸ° JACKPOT!',dlose:'ğŸ˜¬ Peccato!',
    pwon:(n)=>`GIOCATORE ${n} HA VINTO!`,draw:'PAREGGIO!',
    again:'GIOCA ANCORA',bmenu:'â† MENU',ms:'MATCH',lv:'LIVELLO',
  }
};
let lang='en',L=T.en;
function setLang(l){lang=l;L=T[l];applyL();showScreen('sm')}
function st(id,v){const e=document.getElementById(id);if(e&&v!==undefined)e.textContent=v}
function applyL(){
  st('lcl',L.cl);st('mttl',L.mode);st('msub',L.msub);st('bsp',L.sp);st('bmp',L.mp);
  st('atag',L.atag);st('barc',L.start);st('baback',L.back);
  st('muttl',L.mtype);st('musub',L.rounds);st('mo1',L.mo1);st('mo3',L.mo3);st('mo5',L.mo5);
  st('muback',L.back);st('lpa',L.pa);st('lsc',L.sc);st('ler',L.er);
  st('gottl',L.ylose);st('gosub',L.tup);st('brtry',L.retry);st('bgomnu',L.menu);
  buildArcList();
}

// â”€â”€ LEVELS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// All grids are COLS Ã— ROWS where COLS=6 (vertical = more rows than cols)
// â˜…[4] Grid is 6 cols Ã— 8 rows = 48 cards = 24 pairs for max level
// SVG_BACK is defined above as inline SVG constant

const LVS=[
  // id,name,emo,cols,rows,timeLimit(s),malusAt,bonusAt,emojis,bg,backGrad1,backGrad2,accent,logoFilter(CSS filter for SVG tint)
  {id:1,name:'OCEAN',emo:'ğŸŒŠ',cols:2,rows:2,tl:50,ma:0,bo:0,
   em:['ğŸ ','ğŸ¦ˆ'],
   bg:'#010d1a',b1:'#082540',b2:'#030e1f',ac:'#00c8f0',
   theme:'ocean'},
  {id:2,name:'FOREST',emo:'ğŸŒ¿',cols:3,rows:2,tl:65,ma:5,bo:4,
   em:['ğŸŒ²','ğŸ„','ğŸ¦Š'],
   bg:'#020e04',b1:'#062a0c',b2:'#031607',ac:'#4ecb6e',
   theme:'forest'},
  {id:3,name:'BARğŸº',emo:'ğŸ»',cols:4,rows:3,tl:90,ma:5,bo:3,
   em:['ğŸº','ğŸ»','ğŸ·','ğŸ¸','ğŸ¹','ğŸ¥‚'],
   bg:'#1a0900',b1:'#3a1a00',b2:'#200d00',ac:'#f5a623',
   theme:'bar'},
  {id:4,name:'SPACE',emo:'ğŸš€',cols:4,rows:4,tl:120,ma:4,bo:3,
   em:['ğŸš€','ğŸŒ™','â­','ğŸª','ğŸ‘¾','â˜„ï¸','ğŸ›¸','ğŸŒŒ'],
   bg:'#04010f',b1:'#160838',b2:'#08031e',ac:'#9d4edd',
   theme:'space'},
  {id:5,name:'MOOD',emo:'ğŸ˜',cols:5,rows:4,tl:150,ma:4,bo:3,
   em:['ğŸ˜‚','ğŸ˜','ğŸ¤¯','ğŸ˜','ğŸ¥³','ğŸ˜±','ğŸ¥º','ğŸ˜´','ğŸ¤©','ğŸ˜¤'],
   bg:'#18100a',b1:'#382200',b2:'#1d1200',ac:'#ffd166',
   theme:'mood'},
  {id:6,name:'SPORTS',emo:'ğŸ†',cols:6,rows:4,tl:180,ma:12,bo:3,
   em:['âš½','ğŸ¾','ğŸ€','ğŸ¯','ğŸŠ','ğŸš´','ğŸ‹ï¸','ğŸ¤º','ğŸ„','â›·ï¸','ğŸ¤¸','ğŸ³'],
   bg:'#00160a',b1:'#002d12',b2:'#001809',ac:'#06d6a0',
   theme:'sports'},
  {id:7,name:'ANIMALS',emo:'ğŸ¦',cols:6,rows:6,tl:240,ma:10,bo:3,
   em:['ğŸ¦','ğŸ˜','ğŸ¦’','ğŸ¼','ğŸ¦‹','ğŸ¦œ','ğŸ¬','ğŸ¦Š','ğŸ¸','ğŸ§','ğŸ¦€','ğŸ¦™','ğŸ','ğŸ¦…','ğŸ¦','ğŸŠ','ğŸ¦ˆ','ğŸ¦§'],
   bg:'#120800',b1:'#281200',b2:'#160900',ac:'#e07a40',
   theme:'animals'},
  {id:8,name:'MUSIC',emo:'ğŸ¸',cols:6,rows:8,tl:300,ma:10,bo:3,
   em:['ğŸ¸','ğŸº','ğŸ»','ğŸ¥','ğŸ¹','ğŸ·','ğŸ¤','ğŸµ','ğŸ§','ğŸ“»','ğŸª—','ğŸª˜',
       'ğŸ¼','ğŸ™ï¸','ğŸ”Š','ğŸšï¸','ğŸ›ï¸','ğŸªˆ','ğŸ¶','ğŸƒ','ğŸ¨','ğŸ­','ğŸª','ğŸ¯'],
   bg:'#040010',b1:'#12002e',b2:'#080018',ac:'#ff00ff',
   theme:'music'},
];

// Multiplayer skins
const MSKINS=[
  {bg:'#010d1a',b1:'#082540',b2:'#030e1f',ac:'#00c8f0',
  {bg:'#1a0900',b1:'#3a1a00',b2:'#200d00',ac:'#f5a623',
  {bg:'#04010f',b1:'#160838',b2:'#08031e',ac:'#9d4edd',
  {bg:'#00160a',b1:'#002d12',b2:'#001809',ac:'#06d6a0',
  {bg:'#040010',b1:'#12002e',b2:'#080018',ac:'#ff00ff',
];

// â”€â”€ UNLOCKS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getUn(){try{return JSON.parse(localStorage.getItem('mg_un')||'[1]')}catch{return[1]}}
function addUn(id){const u=getUn();if(!u.includes(id)){u.push(id);localStorage.setItem('mg_un',JSON.stringify(u))}}
function isUn(id){return getUn().includes(id)}

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const G={
  mode:'sp',lv:null,cards:[],flip:[],
  matched:0,total:0,score:0,errors:0,
  timer:0,tl:0,tInt:null,
  mc:0,bc:[0,0],           // malus counter, bonus counters [p1,p2]
  streakOk:0,
  locked:false,
  hintIds:[],extraTry:false,peekTO:null,
  cur:0,pPairs:[0,0],
  skipNxt:false,stealAct:false,
  totalRounds:1,curRound:1,rWins:[0,0],skin:0,
};

// â”€â”€ THEME CANVAS ENGINE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let TC={canvas:null,ctx:null,anim:null,theme:'',W:0,H:0,
  ripples:[],vines:[],stars:[],particles:[]};

function initTheme(theme,bg){
  const cv=document.getElementById('theme-canvas');
  TC.canvas=cv;TC.ctx=cv.getContext('2d');
  TC.W=cv.width=cv.offsetWidth||document.getElementById('sg').offsetWidth||390;
  TC.H=cv.height=cv.offsetHeight||document.getElementById('sg').offsetHeight||844;
  TC.theme=theme;TC.ripples=[];TC.vines=[];TC.stars=[];TC.particles=[];
  if(TC.anim){cancelAnimationFrame(TC.anim);TC.anim=null}
  cv.style.background=bg;
  cv.onclick=null;cv.ontouchstart=null;
  cv.classList.remove('interactive');

  if(theme==='ocean'){
    cv.classList.add('interactive');
    initOcean();
    cv.addEventListener('touchstart',handleOceanTouch,{passive:true});
    cv.addEventListener('click',handleOceanClick);
  }else if(theme==='forest'){
    cv.classList.add('interactive');
    initForest();
    cv.addEventListener('touchstart',handleVineTouch,{passive:true});
    cv.addEventListener('click',handleVineClick);
  }else if(theme==='space'){
    initSpace();
  }else if(theme==='bar'){
    initBar();
  }else if(theme==='music'){
    initMusic();
  }else{
    initGeneric(bg);
  }
  if(theme!=='ocean'&&theme!=='forest'&&theme!=='space'&&theme!=='bar'&&theme!=='music'){
    // generic: just clear
  }
  drawTheme();
}

function stopTheme(){
  if(TC.anim){cancelAnimationFrame(TC.anim);TC.anim=null}
  const cv=document.getElementById('theme-canvas');
  if(cv){
    cv.removeEventListener('touchstart',handleOceanTouch);
    cv.removeEventListener('click',handleOceanClick);
    cv.removeEventListener('touchstart',handleVineTouch);
    cv.removeEventListener('click',handleVineClick);
  }
}

// â”€â”€â”€ OCEAN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initOcean(){
  // background underwater gradient is drawn on canvas
}
function handleOceanTouch(e){
  const r=TC.canvas.getBoundingClientRect();
  for(let t of e.changedTouches){
    addRipple(t.clientX-r.left,t.clientY-r.top,'rgba(0,200,240,0.55)');
  }
}
function handleOceanClick(e){
  const r=TC.canvas.getBoundingClientRect();
  addRipple(e.clientX-r.left,e.clientY-r.top,'rgba(0,200,240,0.55)');
}
function addRipple(x,y,col){
  TC.ripples.push({x,y,r:0,max:80,col,life:1});
}
function drawOcean(t){
  const {ctx,W,H}=TC;
  // deep ocean gradient
  const g=ctx.createLinearGradient(0,0,0,H);
  g.addColorStop(0,'#010d1a');g.addColorStop(1,'#020f26');
  ctx.fillStyle=g;ctx.fillRect(0,0,W,H);
  // slow wave layers
  const wt=t*.0008;
  for(let w=0;w<3;w++){
    ctx.beginPath();
    const wY=H*(.25+w*.18);
    ctx.moveTo(0,wY);
    for(let x=0;x<=W;x+=4){
      ctx.lineTo(x,wY+Math.sin(x*.018+wt+(w*.9))*6*(w+1));
    }
    ctx.lineTo(W,H);ctx.lineTo(0,H);ctx.closePath();
    ctx.fillStyle=`rgba(0,40,80,${.12-.03*w})`;ctx.fill();
  }
  // bubbles
  if(!TC.bubbles) TC.bubbles=Array.from({length:18},()=>({
    x:Math.random()*W,y:H+10,r:Math.random()*4+1,sp:Math.random()*.4+.2,ox:Math.random()*W
  }));
  TC.bubbles.forEach(b=>{
    b.y-=b.sp;
    if(b.y<-10){b.y=H+10;b.x=Math.random()*W}
    const bx=b.x+Math.sin(t*.001+b.ox)*(12);
    ctx.beginPath();ctx.arc(bx,b.y,b.r,0,Math.PI*2);
    ctx.strokeStyle='rgba(0,200,255,.3)';ctx.lineWidth=.8;ctx.stroke();
  });
  // ripples
  TC.ripples=TC.ripples.filter(rp=>{
    rp.r+=2.2;rp.life=1-rp.r/rp.max;
    if(rp.life<=0)return false;
    for(let i=0;i<3;i++){
      const ri=rp.r-i*8;if(ri<0)continue;
      ctx.beginPath();ctx.arc(rp.x,rp.y,ri,0,Math.PI*2);
      ctx.strokeStyle=rp.col.replace('0.55',`${rp.life*.55-i*.12}`);
      ctx.lineWidth=1.5-i*.4;ctx.stroke();
    }
    return true;
  });
}

// â”€â”€â”€ FOREST / VINES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initForest(){
  TC.vines=Array.from({length:8},(_,i)=>({
    x:50+i*(TC.W/7.5),y:0,
    segs:Array.from({length:10},(_,j)=>({dx:0,dy:j*28,vel:0})),
    swinging:false,swingTime:0
  }));
}
function handleVineTouch(e){
  const r=TC.canvas.getBoundingClientRect();
  for(let t of e.changedTouches) touchVine(t.clientX-r.left,t.clientY-r.top);
}
function handleVineClick(e){
  const r=TC.canvas.getBoundingClientRect();
  touchVine(e.clientX-r.left,e.clientY-r.top);
}
function touchVine(tx,ty){
  TC.vines.forEach(v=>{
    const tipY=v.y+v.segs.reduce((a,s)=>a+s.dy,0);
    const dist=Math.hypot(tx-v.x,ty-tipY);
    if(dist<55){v.swinging=true;v.swingTime=0;
      v.segs.forEach((s,i)=>{s.vel=(Math.random()-.5)*6*(i*.2+1)})}
  });
}
function drawForest(t){
  const {ctx,W,H}=TC;
  // forest bg
  const g=ctx.createLinearGradient(0,0,0,H);
  g.addColorStop(0,'#020e04');g.addColorStop(.7,'#031007');g.addColorStop(1,'#020b04');
  ctx.fillStyle=g;ctx.fillRect(0,0,W,H);
  // light rays
  ctx.save();
  for(let i=0;i<5;i++){
    const rx=W*.15+i*(W*.18);
    const lx=Math.sin(t*.0004+i)*18;
    const gr=ctx.createLinearGradient(rx+lx,0,rx+lx+30,H*.7);
    gr.addColorStop(0,'rgba(80,200,80,.06)');
    gr.addColorStop(1,'rgba(80,200,80,0)');
    ctx.fillStyle=gr;ctx.fillRect(rx+lx,0,20,H*.7);
  }
  ctx.restore();
  // vines
  TC.vines.forEach(v=>{
    if(v.swinging){
      v.swingTime++;
      v.segs.forEach((s,i)=>{
        s.vel*=.92;s.vel+=Math.sin(v.swingTime*.05-i*.2)*0.08;
        s.dx+=s.vel;s.dx*=.88;
      });
      if(v.swingTime>120) v.swinging=false;
    } else {
      v.segs.forEach(s=>{s.dx+=Math.sin(t*.0006)*0.015;s.dx*=.97});
    }
    // draw vine
    ctx.save();ctx.translate(v.x,v.y);
    let cx2=0,cy2=0;
    ctx.beginPath();ctx.moveTo(0,0);
    v.segs.forEach(s=>{
      cx2+=s.dx;cy2+=s.dy;
      ctx.lineTo(cx2,cy2);
      // leaf at each node
      if(Math.random()<.015){
        const leafR=Math.PI*.25*(Math.random()>.5?1:-1);
        ctx.save();ctx.translate(cx2,cy2);ctx.rotate(leafR);
        ctx.fillStyle=`rgba(60,180,60,${.5+Math.random()*.3})`;
        ctx.beginPath();ctx.ellipse(0,0,5,3,0,0,Math.PI*2);ctx.fill();
        ctx.restore();
      }
    });
    ctx.strokeStyle='rgba(40,140,40,.55)';ctx.lineWidth=2;ctx.stroke();
    ctx.restore();
  });
  // fireflies
  if(!TC.flies) TC.flies=Array.from({length:12},()=>({
    x:Math.random()*TC.W,y:Math.random()*TC.H,
    vx:(Math.random()-.5)*.5,vy:(Math.random()-.5)*.5,
    ph:Math.random()*Math.PI*2
  }));
  TC.flies.forEach(f=>{
    f.x+=f.vx;f.y+=f.vy;
    if(f.x<0||f.x>TC.W)f.vx*=-1;
    if(f.y<0||f.y>TC.H)f.vy*=-1;
    const glow=(.5+Math.sin(t*.004+f.ph)*.5);
    ctx.beginPath();ctx.arc(f.x,f.y,2,0,Math.PI*2);
    ctx.fillStyle=`rgba(180,255,100,${glow*.7})`;ctx.fill();
    if(glow>.7){
      ctx.beginPath();ctx.arc(f.x,f.y,5,0,Math.PI*2);
      ctx.fillStyle=`rgba(180,255,100,${(glow-.7)*.3})`;ctx.fill();
    }
  });
}

// â”€â”€â”€ SPACE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initSpace(){
  TC.stars=Array.from({length:100},()=>({
    x:Math.random()*TC.W,y:Math.random()*TC.H,
    r:Math.random()*1.5+.3,ph:Math.random()*Math.PI*2,sp:Math.random()*.04+.01
  }));
  TC.meteors=[];
}
function drawSpace(t){
  const {ctx,W,H}=TC;
  ctx.fillStyle='#04010f';ctx.fillRect(0,0,W,H);
  // nebula
  const ng=ctx.createRadialGradient(W*.3,H*.3,0,W*.3,H*.3,W*.5);
  ng.addColorStop(0,'rgba(80,0,120,.18)');ng.addColorStop(1,'transparent');
  ctx.fillStyle=ng;ctx.fillRect(0,0,W,H);
  // stars
  TC.stars.forEach(s=>{
    const br=.4+Math.sin(t*s.sp+s.ph)*.4;
    ctx.beginPath();ctx.arc(s.x,s.y,s.r,0,Math.PI*2);
    ctx.fillStyle=`rgba(255,255,255,${br})`;ctx.fill();
  });
  // random meteor
  if(Math.random()<.008){TC.meteors.push({x:Math.random()*W,y:0,len:60,sp:7,life:1})}
  TC.meteors=TC.meteors.filter(m=>{
    m.x+=m.sp;m.y+=m.sp*1.5;m.life-=.04;
    if(m.life<=0)return false;
    ctx.save();ctx.globalAlpha=m.life;
    ctx.strokeStyle='rgba(200,180,255,.8)';ctx.lineWidth=1.5;
    ctx.beginPath();ctx.moveTo(m.x,m.y);ctx.lineTo(m.x-m.len*.5,m.y-m.len*.75);
    ctx.stroke();ctx.restore();
    return true;
  });
}

// â”€â”€â”€ BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initBar(){
  TC.bubbles2=Array.from({length:30},()=>({
    x:Math.random()*TC.W,y:TC.H+Math.random()*TC.H,
    r:Math.random()*6+2,sp:Math.random()*.8+.3,
    col:`hsl(${Math.random()*30+20},80%,60%)`
  }));
  TC.glows=Array.from({length:5},(_,i)=>({
    x:TC.W*(i/4),y:TC.H*.7+Math.random()*TC.H*.3,r:80+Math.random()*40
  }));
}
function drawBar(t){
  const {ctx,W,H}=TC;
  const g=ctx.createLinearGradient(0,0,0,H);
  g.addColorStop(0,'#1a0900');g.addColorStop(1,'#0a0400');
  ctx.fillStyle=g;ctx.fillRect(0,0,W,H);
  // neon light glows on ceiling
  TC.glows.forEach((gl,i)=>{
    const pulse=.5+Math.sin(t*.003+i)*.5;
    const rg=ctx.createRadialGradient(gl.x,0,0,gl.x,0,gl.r);
    rg.addColorStop(0,`rgba(245,166,35,${pulse*.15})`);
    rg.addColorStop(1,'transparent');
    ctx.fillStyle=rg;ctx.fillRect(0,0,W,gl.r);
  });
  // beer bubbles rising
  TC.bubbles2.forEach(b=>{
    b.y-=b.sp;
    if(b.y<-20){b.y=H+10;b.x=Math.random()*W}
    const bx=b.x+Math.sin(t*.002+b.y*.01)*8;
    ctx.beginPath();ctx.arc(bx,b.y,b.r,0,Math.PI*2);
    ctx.fillStyle=b.col.replace(')',`,${.15+Math.random()*.1})`).replace('hsl','hsla');
    ctx.fill();
    ctx.strokeStyle=b.col.replace(')',`,.35)`).replace('hsl','hsla');
    ctx.lineWidth=.8;ctx.stroke();
  });
  // foam line at top
  ctx.beginPath();ctx.moveTo(0,H*.08);
  for(let x=0;x<=W;x+=6)ctx.lineTo(x,H*.08+Math.sin(x*.05+t*.002)*3);
  ctx.strokeStyle='rgba(255,230,150,.12)';ctx.lineWidth=2;ctx.stroke();
}

// â”€â”€â”€ MUSIC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initMusic(){
  TC.notes=Array.from({length:14},()=>({
    x:Math.random()*TC.W,y:Math.random()*TC.H,
    vx:(Math.random()-.5)*.6,vy:-(Math.random()*.5+.2),
    life:Math.random(),ph:Math.random()*Math.PI*2,
    glyph:['â™©','â™ª','â™«','â™¬','ğŸµ'][Math.floor(Math.random()*5)],size:12+Math.random()*14
  }));
  TC.equalizer=Array.from({length:20},()=>Math.random());
}
function drawMusic(t){
  const {ctx,W,H}=TC;
  ctx.fillStyle='#040010';ctx.fillRect(0,0,W,H);
  // equalizer bars at bottom
  const bw=W/TC.equalizer.length;
  TC.equalizer.forEach((h,i)=>{
    TC.equalizer[i]=Math.max(.05,Math.min(1,h+(Math.random()-.5)*.1));
    const bh=TC.equalizer[i]*H*.22;
    const gc=ctx.createLinearGradient(0,H-bh,0,H);
    gc.addColorStop(0,'rgba(255,0,255,.6)');gc.addColorStop(1,'rgba(120,0,200,.2)');
    ctx.fillStyle=gc;
    ctx.fillRect(i*bw+1,H-bh,bw-2,bh);
  });
  // floating music notes
  TC.notes.forEach(n=>{
    n.x+=n.vx;n.y+=n.vy;n.life+=.005;
    if(n.y<-30||n.life>1){n.y=H+10;n.x=Math.random()*W;n.life=0}
    const al=Math.sin(n.life*Math.PI);
    ctx.save();ctx.globalAlpha=al*.7;
    ctx.font=`${n.size}px serif`;ctx.fillStyle='rgba(200,100,255,1)';
    ctx.fillText(n.glyph,n.x,n.y);ctx.restore();
  });
  // neon grid lines
  ctx.strokeStyle='rgba(180,0,255,.07)';ctx.lineWidth=1;
  for(let y=0;y<H;y+=40){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(W,y);ctx.stroke()}
  for(let x=0;x<W;x+=40){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,H);ctx.stroke()}
}

// â”€â”€â”€ GENERIC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initGeneric(bg){TC.gbg=bg}
function drawGeneric(){const {ctx,W,H}=TC;ctx.fillStyle=TC.gbg||'#0a0a0a';ctx.fillRect(0,0,W,H)}

// â”€â”€â”€ DRAW LOOP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _lt=0;
function drawTheme(ts=0){
  const dt=ts-_lt;_lt=ts;
  if(!TC.ctx){return}
  const {theme}=TC;
  if(theme==='ocean') drawOcean(ts);
  else if(theme==='forest') drawForest(ts);
  else if(theme==='space') drawSpace(ts);
  else if(theme==='bar') drawBar(ts);
  else if(theme==='music') drawMusic(ts);
  else drawGeneric();
  TC.anim=requestAnimationFrame(drawTheme);
}

// â”€â”€ TILED BG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildTiled(id){
  const el=document.getElementById(id);if(!el)return;
  const W=Math.min(window.innerWidth,430),H=window.innerHeight;
  const cs=48,gap=4;
  const cols=Math.ceil(W/(cs+gap)),rows=Math.ceil(H/(cs+gap));
  el.style.gridTemplateColumns=`repeat(${cols},${cs}px)`;
  el.style.gridTemplateRows=`repeat(${rows},${cs}px)`;
  const pool=LVS.flatMap(l=>l.em);
  el.innerHTML='';
  for(let i=0;i<cols*rows;i++){
    const d=document.createElement('div');d.className='tbc';
    if(Math.random()>.42)d.textContent=pool[Math.floor(Math.random()*pool.length)];
    el.appendChild(d);
  }
}

// â”€â”€ SPLASH INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initSplash(){
  // Inject splash logo SVG (Layer 3 â€” between bg and text)
  document.getElementById('splash-svg-wrap').innerHTML=SVG_SPLASH_LOGO;

  // Inject real back-card SVG onto the 3D splash cards
  // The back card SVG has its own fixed colors (white paths) â€” wrap without color override
  const sc0back=document.getElementById('sc0back');
  const sc1back=document.getElementById('sc1back');
  const backSvgWrap = `<div style="width:54%;height:54%;display:flex;align-items:center;justify-content:center;position:relative;z-index:1;opacity:0.88">${SVG_BACK}</div>`;
  if(sc0back) sc0back.innerHTML=backSvgWrap;
  if(sc1back) sc1back.innerHTML=backSvgWrap;

  // Sparks
  const c=document.getElementById('sparks');
  for(let i=0;i<28;i++){
    const s=document.createElement('div');s.className='spark';
    s.style.left=Math.random()*100+'%';
    const sz=(Math.random()*3+1)+'px';s.style.width=s.style.height=sz;
    s.style.animationDuration=(Math.random()*7+4)+'s';
    s.style.animationDelay=(Math.random()*7)+'s';
    s.style.background=`hsl(${Math.random()*60+260},80%,80%)`;
    c.appendChild(s);
  }
  // 3D swipe cards
  initSplashCards();
}

// â”€â”€ SPLASH 3D CARDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initSplashCards(){
  const cards=[document.getElementById('sc0'),document.getElementById('sc1')];
  cards.forEach((card,i)=>{
    let startX=0,dragging=false,flipped=false;
    function onStart(e){
      const x=e.touches?e.touches[0].clientX:e.clientX;
      startX=x;dragging=true;
    }
    function onMove(e){
      if(!dragging)return;
      const x=e.touches?e.touches[0].clientX:e.clientX;
      const dx=x-startX;
      // live rotate during drag
      const inner=card.querySelector('.s-card-inner');
      const baseRot=flipped?180:0;
      const rot=baseRot+Math.max(-90,Math.min(90,dx*1.2));
      inner.style.transition='none';
      inner.style.transform=`rotateY(${rot}deg)`;
    }
    function onEnd(e){
      if(!dragging)return;dragging=false;
      const x=e.changedTouches?e.changedTouches[0].clientX:e.clientX;
      const dx=x-startX;
      const inner=card.querySelector('.s-card-inner');
      inner.style.transition='transform .5s cubic-bezier(.4,0,.2,1)';
      if(Math.abs(dx)>30){flipped=!flipped}
      inner.style.transform=`rotateY(${flipped?180:0}deg)`;
    }
    card.addEventListener('mousedown',onStart);
    card.addEventListener('mousemove',onMove);
    card.addEventListener('mouseup',onEnd);
    card.addEventListener('touchstart',onStart,{passive:true});
    card.addEventListener('touchmove',onMove,{passive:true});
    card.addEventListener('touchend',onEnd);
    // also tap to flip
    card.addEventListener('click',()=>{
      flipped=!flipped;
      const inner=card.querySelector('.s-card-inner');
      inner.style.transition='transform .5s cubic-bezier(.4,0,.2,1)';
      inner.style.transform=`rotateY(${flipped?180:0}deg)`;
    });
  });
}

// â”€â”€ NAV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showScreen(id){
  stopTheme();
  document.querySelectorAll('.screen.active').forEach(s=>s.classList.remove('active'));
  const el=document.getElementById(id);if(!el)return;
  el.classList.add('active');
  if(id==='sl')buildTiled('tbgl');
  if(id==='sm'){buildTiled('tbgm');applyL()}
  if(id==='sa'){buildTiled('tbga');buildArcList()}
  if(id==='smu'){buildTiled('tbgmu');applyL()}
}

// â”€â”€ ARCADE LIST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildArcList(){
  const el=document.getElementById('arclist');if(!el)return;
  el.innerHTML='';const un=getUn();
  LVS.forEach(lv=>{
    const open=un.includes(lv.id);
    const d=document.createElement('div');
    d.className='lvrow'+(open?'':' lkd');
    if(open)d.style.borderColor=lv.ac+'55';
    d.innerHTML=`<span style="font-size:17px">${lv.emo}</span>
      <span style="font-family:'Bebas Neue',sans-serif;font-size:14px;letter-spacing:2px;color:${open?'#fff':'rgba(255,255,255,.4)'}">
        ${L.lv} ${lv.id} â€” ${lv.name}
      </span>
      <span style="margin-left:auto;font-size:12px;color:${open?lv.ac:'rgba(255,255,255,.3)'}">
        ${open?`â–¶ ${lv.cols}Ã—${lv.rows}`:'ğŸ”’'}</span>`;
    el.appendChild(d);
  });
}
function showArc(){showScreen('sa')}
function startArcade(){
  const un=getUn();const maxId=Math.max(...un);
  G.mode='sp';startGame(LVS.find(l=>l.id===maxId)||LVS[0]);
}
function showMulti(){showScreen('smu')}
function startMultiGame(n){
  G.mode='mp';G.totalRounds=n;G.curRound=1;G.rWins=[0,0];
  G.pPairs=[0,0];G.cur=0;G.skin=0;startGame(LVS[7]);
}

// â”€â”€ BUILD EVENT BARS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildBarsUI(lv){
  const el=document.getElementById('ebars');el.innerHTML='';
  if(G.mode==='sp'){
    // SP: one malus + one bonus bar (shared)
    el.innerHTML=`
      <div class="ebar">
        <span class="elbl m" id="lml">${L.ml}</span>
        <div class="etrack"><div class="efill m" id="mfill"></div></div>
        <div class="edots" id="mdots"></div>
      </div>
      <div class="ebar">
        <span class="elbl b" id="lbn">${L.bn}</span>
        <div class="etrack"><div class="efill b" id="bfill"></div></div>
        <div class="edots" id="bdots"></div>
      </div>`;
    const mm=lv.ma||1,bm=lv.bo||1;
    const md=document.getElementById('mdots'),bd=document.getElementById('bdots');
    for(let i=0;i<mm;i++){const d=document.createElement('div');d.className='edot';d.id=`md${i}`;md.appendChild(d)}
    for(let i=0;i<bm;i++){const d=document.createElement('div');d.className='edot';d.id=`bd${i}`;bd.appendChild(d)}
  } else {
    // MP: one malus (shared) + TWO bonus bars (one per player)
    el.innerHTML=`
      <div class="ebar">
        <span class="elbl m" id="lml">${L.ml}</span>
        <div class="etrack"><div class="efill m" id="mfill"></div></div>
        <div class="edots" id="mdots"></div>
      </div>
      <div class="ebar">
        <span class="elbl b1" id="lb1">${L.b1}</span>
        <div class="etrack"><div class="efill b1" id="b1fill"></div></div>
        <div class="edots" id="b1dots"></div>
      </div>
      <div class="ebar">
        <span class="elbl b2" id="lb2">${L.b2}</span>
        <div class="etrack"><div class="efill b2" id="b2fill"></div></div>
        <div class="edots" id="b2dots"></div>
      </div>`;
    const mm=lv.ma,bm=lv.bo;
    const md=document.getElementById('mdots');
    const b1d=document.getElementById('b1dots'),b2d=document.getElementById('b2dots');
    for(let i=0;i<mm;i++){const d=document.createElement('div');d.className='edot';d.id=`md${i}`;md.appendChild(d)}
    for(let i=0;i<bm;i++){const d=document.createElement('div');d.className='edot';d.id=`b1d${i}`;b1d.appendChild(d)}
    for(let i=0;i<bm;i++){const d=document.createElement('div');d.className='edot';d.id=`b2d${i}`;b2d.appendChild(d)}
  }
  updateBars();
}

function updateBars(){
  const lv=G.lv;if(!lv)return;
  const mm=lv.ma||1,bm=lv.bo||1;
  // malus (always)
  for(let i=0;i<mm;i++){const d=document.getElementById(`md${i}`);if(d)d.className='edot'+(i<G.mc?' mf':'')}
  const mf=document.getElementById('mfill');if(mf)mf.style.width=`${Math.min((G.mc/mm)*100,100)}%`;

  if(G.mode==='sp'){
    for(let i=0;i<bm;i++){const d=document.getElementById(`bd${i}`);if(d)d.className='edot'+(i<G.bc[0]?' bf':'')}
    const bf=document.getElementById('bfill');if(bf)bf.style.width=`${Math.min((G.bc[0]/bm)*100,100)}%`;
  } else {
    for(let p=0;p<2;p++){
      for(let i=0;i<bm;i++){
        const d=document.getElementById(`b${p+1}d${i}`);
        if(d)d.className=`edot${i<G.bc[p]?(p===0?' b1f':' b2f'):''}`;
      }
      const bf=document.getElementById(`b${p+1}fill`);
      if(bf)bf.style.width=`${Math.min((G.bc[p]/bm)*100,100)}%`;
    }
  }
}

// â”€â”€ GAME START â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startGame(lv){
  G.lv=lv;G.cards=[];G.flip=[];
  G.matched=0;G.total=(lv.cols*lv.rows)/2;
  G.score=0;G.errors=0;G.timer=0;
  G.mc=0;G.bc=[0,0];G.streakOk=0;
  G.locked=false;G.hintIds=[];G.extraTry=false;
  G.skipNxt=false;G.stealAct=false;
  if(G.tInt)clearInterval(G.tInt);

  let sk=lv;
  if(G.mode==='mp'){const s=MSKINS[G.skin%MSKINS.length];sk={...lv,...s,name:LVS[7].name}}

  // theme canvas
  const sgEl=document.getElementById('sg');
  sgEl.style.background=sk.bg;
  const tcv=document.getElementById('theme-canvas');
  // size canvas to game screen
  setTimeout(()=>{
    tcv.width=sgEl.offsetWidth;tcv.height=sgEl.offsetHeight;
    initTheme(lv.theme||'',sk.bg);
  },50);

  st('hlv',G.mode==='mp'?`${sk.name||'MUSIC'} R${G.curRound}/${G.totalRounds}`:lv.name);

  G.tl=G.mode==='sp'?lv.tl:0;
  const cf=document.getElementById('cdf');
  cf.style.transition='none';cf.style.width=G.mode==='sp'?'100%':'0';
  cf.style.backgroundPosition='0% 50%';
  document.getElementById('htim').className='htim';

  const tb=document.getElementById('tban');
  tb.style.display=G.mode==='mp'?'flex':'none';
  if(G.mode==='mp'){updateTBan()}

  buildBarsUI(lv);buildGrid(sk);updateHUD();

  ['evov','cov','gov','wov'].forEach(id=>{
    const el=document.getElementById(id);if(el)el.classList.remove('show')
  });
  document.getElementById('pkbar').style.display='none';

  showScreen('sg');
  // start timer after canvas init
  setTimeout(()=>{G.tInt=setInterval(tick,1000)},400);
}

// â”€â”€ TICK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function tick(){
  G.timer++;
  const hel=document.getElementById('htim');
  if(G.mode==='sp'){
    const rem=Math.max(0,G.tl-G.timer);
    const m=Math.floor(rem/60),s=rem%60;
    hel.textContent=`${m}:${s.toString().padStart(2,'0')}`;
    hel.className='htim'+(rem<=10?' danger':rem<=30?' warn':'');
    const pct=(rem/G.tl)*100;
    const cf=document.getElementById('cdf');
    cf.style.width=pct+'%';cf.style.backgroundPosition=`${100-pct}% 50%`;
    if(rem<=0){clearInterval(G.tInt);doGO()}
  } else {
    const m=Math.floor(G.timer/60),s=G.timer%60;
    hel.textContent=`${m}:${s.toString().padStart(2,'0')}`;
  }
}
function doGO(){
  G.locked=true;
  document.getElementById('gov').classList.add('show');
  document.getElementById('brtry').onclick=()=>{
    document.getElementById('gov').classList.remove('show');startGame(G.lv)};
  document.getElementById('bgomnu').onclick=()=>{
    document.getElementById('gov').classList.remove('show');showScreen('sm')};
}

// â”€â”€ TURN BANNER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateTBan(){
  const cols=['#4488ff','#ff4466'];
  const nm=[L.p1,L.p2];
  const td=document.getElementById('tdot');if(td)td.style.background=cols[G.cur];
  const tl=document.getElementById('tlbl');
  if(tl){tl.textContent=nm[G.cur]+(L.pturn||"'S TURN");tl.style.color=cols[G.cur]}
  const ts=document.getElementById('tsc');if(ts)ts.textContent=`${G.pPairs[0]} â€” ${G.pPairs[1]}`;
}

// â”€â”€ GRID â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildGrid(sk){
  const lv=G.lv;
  const grid=document.getElementById('card-grid');
  // â˜…[4] cols=6, rows=8 means 6 columns (vertical layout)
  grid.style.gridTemplateColumns=`repeat(${lv.cols},1fr)`;
  grid.innerHTML='';G.cards=[];
  const pairs=[];
  for(let i=0;i<G.total;i++){const e=lv.em[i%lv.em.length];pairs.push(e,e)}
  shuffle(pairs);
  pairs.forEach((e,idx)=>{
    const card={idx,e,el:null,flipped:false,matched:false};
    const el=document.createElement('div');el.className='card';
    el.innerHTML=`<div class="ci">
      <div class="cface cback" style="background:linear-gradient(135deg,${sk.b1},${sk.b2})">
        <div class="cback-svg" style="color:${sk.ac}">${SVG_BACK}</div>
      </div>
      <div class="cface cfront">${e}</div>
    </div>`;
    el.addEventListener('click',()=>onCard(idx));
    card.el=el;G.cards.push(card);grid.appendChild(el);
  });
}
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a}

// â”€â”€ CARD CLICK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function onCard(idx){
  if(G.locked)return;
  const c=G.cards[idx];
  if(!c||c.flipped||c.matched)return;
  if(G.flip.length>=2)return;
  if(G.flip.length===1&&G.flip[0]===idx)return;
  c.flipped=true;c.el.classList.add('flipped','peek');
  G.flip.push(idx);
  setTimeout(()=>c.el.classList.remove('peek'),500);
  if(G.flip.length===2){G.locked=true;setTimeout(evalPair,650)}
}
function evalPair(){
  const [a,b]=G.flip.map(i=>G.cards[i]);
  if(a.e===b.e){
    // â˜…[1] SP: reset malus bar on any correct match
    if(G.mode==='sp')G.mc=0;
    doMatch(a,b);
  } else {
    doMiss(a,b);
  }
  G.flip=[];
}

// â”€â”€ MATCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function doMatch(a,b){
  a.matched=b.matched=true;
  a.el.classList.add('matched');b.el.classList.add('matched');
  G.matched++;G.score+=100+Math.max(0,20-G.timer%60);

  if(G.mode==='mp'){
    if(G.stealAct){
      const opp=1-G.cur;
      if(G.pPairs[opp]>0){G.pPairs[opp]--;G.pPairs[G.cur]++}else G.pPairs[G.cur]++;
      G.stealAct=false;toast('ğŸ¯ STOLEN!');
    }else G.pPairs[G.cur]++;
    updateTBan();
  }

  setTimeout(()=>{
    a.el.classList.add('removing');b.el.classList.add('removing');
    setTimeout(()=>{
      a.el.style.visibility='hidden';b.el.style.visibility='hidden';
      a.el.classList.remove('removing');b.el.classList.remove('removing');
    },360);
  },440);

  clearHints();G.extraTry=false;

  // â˜…[1] SP: bonus bar (bc[0]) increments on consecutive match, resets on miss (handled in doMiss)
  // â˜…[1] MP: bonus bar for current player resets on turn switch
  const lv=G.lv;
  if(lv.bo>0){
    const pi=G.mode==='mp'?G.cur:0;
    G.bc[pi]++;
    if(G.bc[pi]>=lv.bo){
      G.bc[pi]=0;updateBars();
      setTimeout(()=>{
        if(G.matched>=G.total)return; // â˜…[2] don't show bonus if game ended
        doBonus();
      },820);
      updateHUD();return;
    }
  }
  updateBars();updateHUD();
  setTimeout(()=>{G.locked=false;checkWin()},830);
}

// â”€â”€ MISS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function doMiss(a,b){
  a.el.classList.add('wrong');b.el.classList.add('wrong');
  G.errors++;
  // â˜…[1] SP: bonus bar resets on miss; malus bar increments
  // â˜…[1] SP: malus bar resets on any correct match (bc[0] not relevant to malus reset here)
  // Malus bar: resets when match happens? No â€” malus is INDEPENDENT streak of fails
  // RE-READ req: "malus bar resets when you get a match" (SP only)
  // "MP: cumulative between players, higher threshold"
  if(G.mode==='sp'){
    G.bc[0]=0; // bonus streak broken
    G.mc++;
  } else {
    // â˜…[1] MP: cumulative, all players' errors feed the same bar
    G.mc++;
  }
  updateBars();updateHUD();

  setTimeout(()=>{
    a.el.classList.remove('wrong');b.el.classList.remove('wrong');
    a.flipped=false;b.flipped=false;
    a.el.classList.remove('flipped');b.el.classList.remove('flipped');

    const lv=G.lv;
    if(G.mc>=lv.ma&&lv.ma>0){
      G.mc=0;updateBars();setTimeout(doMalus,160);return;
    }
    updateBars();

    if(G.mode==='mp'){
      // bonus bar for current player resets on turn switch
      G.bc[G.cur]=0;
      if(G.skipNxt){
        G.skipNxt=false;toast(`â­ ${G.cur===0?L.p2:L.p1} SKIPPED`);
      }else{
        G.cur=1-G.cur;updateTBan();
        toast((G.cur===0?L.p1:L.p2)+(L.pturn||"'S TURN"));
      }
    }
    G.locked=false;
  },900);
}

// â˜…[1] SP: malus bar resets when player makes a correct match
// Handled in doMatch: we don't reset mc on match â€” re-reading request:
// "malus bar resets when you guess correctly (single player)"
// So patch doMatch to also reset mc in SP:
const _origDoMatch=doMatch;
// (We implement this inline above â€” adding mc reset for SP in doMatch)

function updateHUD(){
  const spa=document.getElementById('spa');if(spa)spa.textContent=`${G.matched}/${G.total}`;
  const ssc=document.getElementById('ssc');if(ssc)ssc.textContent=G.mode==='mp'?`${G.pPairs[0]}Â·${G.pPairs[1]}`:G.score;
  const ser=document.getElementById('ser');if(ser)ser.textContent=G.errors;
}

// Patch: reset malus bar on match in SP
// We add this at the top of doMatch body by modifying G.mc
// Actually let me just add it properly in flow:
function resetMalusOnMatch(){if(G.mode==='sp'&&G.mc>0){G.mc=0;updateBars()}}

// â”€â”€ MALUS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const MPOOL=['rotation','shuffle','reset'];
function doMalus(){
  const type=MPOOL[Math.floor(Math.random()*MPOOL.length)];
  G.locked=true;
  const cfg={
    rotation:{ico:'ğŸ”„',t:()=>L.rot,d:()=>L.rotd},
    shuffle: {ico:'ğŸ²',t:()=>L.shuf,d:()=>L.shufd},
    reset:   {ico:'ğŸ’¥',t:()=>L.rst, d:()=>L.rstd},
  }[type];
  showOv(cfg.ico,cfg.t(),cfg.d(),[{
    lbl:L.ok,style:'background:linear-gradient(135deg,#d42f5a,#e86c2e);color:#fff;',
    fn:()=>{hideOv();execMalus(type)}
  }]);
}
function execMalus(type){
  const grid=document.getElementById('card-grid');
  if(type==='rotation'){
    grid.classList.add('flipping');
    setTimeout(()=>{mirrorBoard();grid.classList.remove('flipping');G.locked=false},700);
  }else if(type==='shuffle'){
    animShuffle(()=>{shuffleHid();G.locked=false});
  }else{
    animShuffle(()=>{resetBoard()});
  }
}
function mirrorBoard(){
  const u=G.cards.filter(c=>!c.matched&&!c.flipped);
  const em=u.map(c=>c.e).reverse();
  u.forEach((c,i)=>{c.e=em[i];c.el.querySelector('.cfront').textContent=em[i]});
}
function shuffleHid(){
  const u=G.cards.filter(c=>!c.matched&&!c.flipped);
  const em=shuffle(u.map(c=>c.e));
  u.forEach((c,i)=>{c.e=em[i];c.el.querySelector('.cfront').textContent=em[i]});
}
function resetBoard(){
  const all=G.cards.filter(c=>!c.matched);
  const em=shuffle(all.map(c=>c.e));
  all.forEach((c,i)=>{
    c.e=em[i];c.el.querySelector('.cfront').textContent=em[i];
    if(c.flipped){c.flipped=false;c.el.classList.remove('flipped')}
  });
  G.flip=[];G.score=Math.max(0,G.score-150);updateHUD();G.locked=false;
}
function animShuffle(cb){
  const u=G.cards.filter(c=>!c.matched&&!c.flipped);
  u.forEach((c,i)=>{c.el.classList.add('shuffling');c.el.style.animationDelay=(i*.04)+'s'});
  setTimeout(()=>{u.forEach(c=>c.el.classList.remove('shuffling'));cb()},520);
}

// â”€â”€ BONUS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function doBonus(){
  G.locked=true;
  if(G.mode==='sp'){
    const pool=['peek','hint','extra'];
    const chosen=pool[Math.floor(Math.random()*pool.length)];
    toast('âœ¨ '+{peek:L.bpeek,hint:L.bhint,extra:L.bxtr}[chosen]);
    setTimeout(()=>execBonus(chosen),180);
  }else{
    const opts=[
      {ico:'ğŸ‘',t:L.bpeek,d:L.bpeekd,v:'peek',c:'rgba(68,255,136,.13)',bc:'rgba(68,255,136,.4)',tc:'#44ff88'},
      {ico:'ğŸ’¡',t:L.bhint,d:L.bhintd,v:'hint',c:'rgba(68,221,255,.13)',bc:'rgba(68,221,255,.4)',tc:'#44ddff'},
      {ico:'ğŸ¯',t:L.steal,d:L.steald,v:'steal',c:'rgba(255,170,68,.13)',bc:'rgba(255,170,68,.4)',tc:'#ffaa44'},
      {ico:'â­',t:L.skip,d:L.skipd,v:'skip',c:'rgba(200,68,255,.13)',bc:'rgba(200,68,255,.4)',tc:'#cc44ff'},
      {ico:'ğŸ°',t:L.dice,d:L.diced,v:'dice',c:'rgba(255,68,68,.13)',bc:'rgba(255,68,68,.4)',tc:'#ff8888'},
    ];
    showBonusPick(L.bonus,opts,v=>{hideOv();execBonus(v)});
  }
}
function showBonusPick(title,opts,cb){
  document.getElementById('evico').textContent='âœ¨';
  document.getElementById('evttl').textContent=title;
  document.getElementById('evdsc').textContent='';
  const btns=document.getElementById('evbtns');btns.innerHTML='';
  const grid=document.createElement('div');grid.className='bgrid';
  opts.forEach(o=>{
    const b=document.createElement('button');b.className='bopt';
    b.style.cssText=`background:${o.c};border-color:${o.bc};`;
    b.innerHTML=`<span class="bico">${o.ico}</span>
      <span><span class="bttl" style="color:${o.tc}">${o.t}</span>
      <span class="bdsc">${o.d}</span></span>`;
    b.addEventListener('click',()=>cb(o.v));
    grid.appendChild(b);
  });
  btns.appendChild(grid);
  document.getElementById('evov').classList.add('show');
}
function execBonus(type){
  if(type==='peek'){
    const hidden=G.cards.filter(c=>!c.matched&&!c.flipped);
    hidden.forEach(c=>c.el.classList.add('flipped'));
    G.locked=true;
    const bar=document.getElementById('pkbar'),fill=document.getElementById('pkf');
    bar.style.display='block';
    fill.style.transition='none';fill.style.width='100%';
    requestAnimationFrame(()=>requestAnimationFrame(()=>{
      fill.style.transition='width 3s linear';fill.style.width='0%';
    }));
    if(G.peekTO)clearTimeout(G.peekTO);
    G.peekTO=setTimeout(()=>{
      hidden.forEach(c=>{if(!G.flip.includes(c.idx)){c.el.classList.remove('flipped');c.flipped=false}});
      bar.style.display='none';fill.style.transition='none';fill.style.width='100%';
      G.locked=false;checkWin();
    },3000);
  }else if(type==='hint'){
    const u=G.cards.filter(c=>!c.matched&&!c.flipped);
    const em={};u.forEach(c=>{if(!em[c.e])em[c.e]=[];em[c.e].push(c)});
    const pairs=Object.values(em).filter(p=>p.length>=2);
    if(!pairs.length){G.locked=false;return}
    const pair=pairs[Math.floor(Math.random()*pairs.length)];
    G.hintIds=[pair[0].idx,pair[1].idx];
    G.hintIds.forEach(i=>{
      const r=document.createElement('div');r.className='hint-ring';r.id=`hr${i}`;
      G.cards[i].el.appendChild(r);
    });
    toast('ğŸ’¡ '+L.bhint);G.locked=false;
  }else if(type==='extra'){
    G.extraTry=true;toast('ğŸ² '+L.bxtr);G.locked=false;
  }else if(type==='steal'){
    G.stealAct=true;toast('ğŸ¯ '+L.steal);G.locked=false;
  }else if(type==='skip'){
    G.skipNxt=true;toast('â­ '+L.skip);G.locked=false;
  }else if(type==='dice'){
    showOv('ğŸ°',L.risk,L.riskd,[
      {lbl:L.accept,style:'background:linear-gradient(135deg,#ffd166,#ff9f1c);color:#000;',
        fn:()=>{hideOv();rollDice()}},
      {lbl:L.refuse,style:'background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.13);color:#fff;',
        fn:()=>{hideOv();G.locked=false}},
    ]);
  }
}
function rollDice(){
  G.locked=true;showOv('ğŸ²',L.rolling,'ğŸ²',[]);
  setTimeout(()=>{
    const r=Math.floor(Math.random()*6)+1;
    hideOv();toast(`ğŸ² ${r} â€” ${(r===1||r===6)?L.dwin:L.dlose}`);
    if(r===1||r===6)execBonus('peek');else G.locked=false;
  },1200);
}
function clearHints(){document.querySelectorAll('.hint-ring').forEach(r=>r.remove());G.hintIds=[]}

// â”€â”€ OVERLAY HELPER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showOv(ico,ttl,dsc,btns){
  document.getElementById('evico').textContent=ico;
  document.getElementById('evttl').textContent=ttl;
  document.getElementById('evdsc').textContent=dsc;
  const el=document.getElementById('evbtns');el.innerHTML='';
  const row=document.createElement('div');row.className='orow';
  btns.forEach(b=>{
    const btn=document.createElement('button');btn.className='obtn';
    btn.style.cssText=b.style||'background:rgba(255,255,255,.09);border:1px solid rgba(255,255,255,.13);color:#fff;';
    btn.textContent=b.lbl;btn.addEventListener('click',b.fn);
    row.appendChild(btn);
  });
  el.appendChild(row);
  document.getElementById('evov').classList.add('show');
}
function hideOv(){document.getElementById('evov').classList.remove('show')}

// â”€â”€ WIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function checkWin(){
  if(G.matched<G.total)return;
  clearInterval(G.tInt);
  if(G.mode==='sp'){showComplete();addUn(G.lv.id+1)}
  else showRoundEnd();
}
function showComplete(){
  const m=Math.floor(G.timer/60),s=G.timer%60;
  const t=`${m}:${s.toString().padStart(2,'0')}`;
  const er=G.errors/G.total;
  document.getElementById('cst').textContent=er<0.3?'â­â­â­':er<0.7?'â­â­':'â­';
  document.getElementById('cttl').textContent=L.cleared;
  document.getElementById('csc').textContent=L.slbl(G.score,G.errors,t);
  const nxt=LVS.find(l=>l.id===G.lv.id+1);
  const nb=document.getElementById('bnxt');
  if(nxt){nb.textContent=L.next;nb.onclick=()=>{document.getElementById('cov').classList.remove('show');startGame(nxt)}}
  else{nb.textContent='ğŸ† THE END!';nb.onclick=()=>showScreen('sm')}
  document.getElementById('bcmnu').textContent=L.menu;
  document.getElementById('bcmnu').onclick=()=>{document.getElementById('cov').classList.remove('show');showScreen('sm')};
  setTimeout(()=>{document.getElementById('cov').classList.add('show');spawnConf(40)},520);
}

// â”€â”€ MULTI ROUND END â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showRoundEnd(){
  // â˜…[2] This is called from checkWin() which is called from doMatch/after peek
  // bonus is already guarded by "if(G.matched>=G.total) return" in doMatch
  const p0=G.pPairs[0],p1=G.pPairs[1];
  let w=-1;if(p0>p1)w=0;else if(p1>p0)w=1;
  if(w>=0)G.rWins[w]++;
  if(G.curRound>=G.totalRounds){showMatchWin();return}
  G.curRound++;G.skin++;G.pPairs=[0,0];G.cur=0;G.bc=[0,0];G.mc=0;
  const nm=[L.p1,L.p2];
  showOv(w===0?'ğŸ’™':w===1?'â¤ï¸':'ğŸ¤',
    w>=0?`${nm[w]} WON R${G.curRound-1}!`:'ROUND DRAW!',
    `${L.ms}: ${G.rWins[0]} â€” ${G.rWins[1]}`,
    [{lbl:'NEXT ROUND â–¶',style:'background:linear-gradient(135deg,#5a28e0,#2e7de8);color:#fff;',
      fn:()=>{hideOv();startGame(LVS[7])}}]);
}
function showMatchWin(){
  const rw=G.rWins;let w=-1;
  if(rw[0]>rw[1])w=0;else if(rw[1]>rw[0])w=1;
  const wov=document.getElementById('wov');
  wov.style.background=w===0?'radial-gradient(ellipse at 50% 38%,#0d1a4a,#000 70%)':
    w===1?'radial-gradient(ellipse at 50% 38%,#3a0d1a,#000 70%)':
    'radial-gradient(ellipse at 50% 38%,#1a1a1a,#000 70%)';
  const wt=document.getElementById('wttl');
  if(w>=0){wt.textContent=L.pwon(w+1);wt.className='wttl '+(w===0?'wp1':'wp2')}
  else{wt.textContent=L.draw;wt.className='wttl';wt.style.color='#fff'}
  document.getElementById('wsc').textContent=`${L.ms}: ${rw[0]} â€” ${rw[1]}`;
  const wr=document.getElementById('wrow');wr.innerHTML='';
  const b1=document.createElement('button');b1.className='wbp';b1.textContent=L.again;
  b1.onclick=()=>{wov.classList.remove('show');G.rWins=[0,0];G.curRound=1;G.skin=0;G.pPairs=[0,0];G.cur=0;startGame(LVS[7])};
  const b2=document.createElement('button');b2.className='wbs';b2.textContent=L.bmenu;
  b2.onclick=()=>{wov.classList.remove('show');showScreen('sm')};
  wr.appendChild(b1);wr.appendChild(b2);
  animBrain(w);
  setTimeout(()=>{wov.classList.add('show');spawnConf(90)},180);
}

// â”€â”€ BRAIN CANVAS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function animBrain(w){
  const cv=document.getElementById('bc'),ctx=cv.getContext('2d');
  const W=cv.width,H=cv.height,cx=W/2,cy=H/2;
  if(cv._aid)cancelAnimationFrame(cv._aid);
  const hue=w===0?220:w===1?340:200;
  const VBASE=[
    [0,-46],[26,-38],[46,-18],[48,6],[36,26],[16,42],
    [-4,46],[-24,36],[-46,14],[-48,-12],[-36,-30],[-14,-44]
  ];
  let f=0;
  function draw(){
    ctx.clearRect(0,0,W,H);
    const sc=0.88+Math.sin(f*.055)*.12;
    const rot=f*.013;
    const verts=VBASE.map(([x,y])=>{
      const rr=Math.sqrt(x*x+y*y)*sc;
      const a=Math.atan2(y,x)+rot;
      return[cx+Math.cos(a)*rr,cy+Math.sin(a)*rr+8];
    });
    for(let i=0;i<verts.length;i++){
      const j=(i+1)%verts.length;
      ctx.fillStyle=`hsl(${hue+i*6},62%,${30+i*4}%)`;
      ctx.strokeStyle=`hsl(${hue},72%,55%)`;ctx.lineWidth=.8;
      ctx.beginPath();ctx.moveTo(cx,cy+8);
      ctx.lineTo(verts[i][0],verts[i][1]);ctx.lineTo(verts[j][0],verts[j][1]);
      ctx.closePath();ctx.fill();ctx.stroke();
    }
    // crown
    const crx=cx,cry=cy-42*sc;
    ctx.fillStyle='#ffd700';ctx.beginPath();
    ctx.moveTo(crx-18,cry+8);ctx.lineTo(crx-18,cry-5);
    ctx.lineTo(crx-9,cry+2);ctx.lineTo(crx,cry-11);
    ctx.lineTo(crx+9,cry+2);ctx.lineTo(crx+18,cry-5);
    ctx.lineTo(crx+18,cry+8);ctx.closePath();ctx.fill();
    ctx.strokeStyle='#b8860b';ctx.lineWidth=1;ctx.stroke();
    [[crx-18,cry-5],[crx,cry-11],[crx+18,cry-5]].forEach(([x,y])=>{
      ctx.beginPath();ctx.arc(x,y,2.5,0,Math.PI*2);
      ctx.fillStyle=w===0?'#4488ff':w===1?'#ff4466':'#aaa';ctx.fill();
    });
    const blink=Math.sin(f*.08)>.92;const ey=cy+16*sc;
    [-11,11].forEach(ex=>{
      ctx.beginPath();
      if(blink)ctx.ellipse(cx+ex,ey,3.5*sc,1.2*sc,0,0,Math.PI*2);
      else ctx.arc(cx+ex,ey,3.5*sc,0,Math.PI*2);
      ctx.fillStyle='#fff';ctx.fill();
      if(!blink){ctx.beginPath();ctx.arc(cx+ex+.5,ey,1.8*sc,0,Math.PI*2);ctx.fillStyle='#111';ctx.fill()}
    });
    f++;cv._aid=requestAnimationFrame(draw);
  }
  draw();
}

// â”€â”€ CONFETTI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function spawnConf(n=44){
  const cols=['#ff6b6b','#ffd166','#06d6a0','#118ab2','#a855f7','#f472b6','#fff'];
  const app=document.getElementById('app');
  for(let i=0;i<n;i++){
    const c=document.createElement('div');c.className='cfp';
    c.style.left=Math.random()*100+'%';
    c.style.background=cols[Math.floor(Math.random()*cols.length)];
    c.style.animationDuration=(Math.random()*2+1.3)+'s';
    c.style.animationDelay=(Math.random()*.85)+'s';
    const sz=(Math.random()*7+4)+'px';c.style.width=c.style.height=sz;
    if(Math.random()>.5)c.style.borderRadius='50%';
    app.appendChild(c);setTimeout(()=>c.remove(),3200);
  }
}

// â”€â”€ QUIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function confirmQuit(){
  G.locked=true;
  showOv('ğŸšª',L.qq,'',[
    {lbl:L.qy,style:'background:rgba(200,50,50,.2);border:1px solid rgba(200,50,50,.4);color:#ff8888;',
      fn:()=>{hideOv();clearInterval(G.tInt);if(G.peekTO){clearTimeout(G.peekTO);G.peekTO=null}stopTheme();showScreen('sm')}},
    {lbl:L.qn,style:'background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.12);color:#fff;',
      fn:()=>{hideOv();G.locked=false}},
  ]);
}

// â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _tTO;
function toast(msg){
  const el=document.getElementById('toast');
  el.textContent=msg;el.classList.add('show');
  clearTimeout(_tTO);_tTO=setTimeout(()=>el.classList.remove('show'),2100);
}

// â”€â”€ BOOT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
initSplash();
document.getElementById('ss').addEventListener('click',()=>showScreen('sl'));
</script>
</body>
</html>
